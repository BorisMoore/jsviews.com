{"version":3,"sources":["jquery.views.js"],"names":["factory","define","amd","this","jQuery","$","elemChangeHandler","ev","params","sourceValue","setter","cancel","fromAttr","linkCtx","cvtBack","cnvtName","target","$source","view","binding","oldLinkCtx","onBeforeChange","onAfterChange","tag","to","eventArgs","exprOb","source","bindings","_jsvBnd","splitBindings","exec","bindingStore","hlp","onBeforeChangeStr","onAfterChangeStr","defaultAttr","fnSetters","undefined","$isFunction","attr","data","getRsc","call","change","oldValue","_val","value","_jsv","sb","_ctxCb","_","chging","$observable","setProperty","propertyChangeHandler","linkFn","noUpdate","forceUpdate","hasError","onError","elem","cvt","convert","parentElem","parentNode","onEvent","prop","path","_toLk","_er","e","error","Function","props","args","$views","getTargetVal","onUpdate","mergeCtxs","NONE","HTML","onBeforeLink","callAfterLink","observeAndBind","tagName","_cnvt","_tag","tmpl","TRUE","updateContent","_noUpd","currentValue","css","$target","expr","test","slice","style","parseInt","type","CHECKBOX","CHECKED","RADIO","setDefer","_df","deferAttr","prevNode","nextNode","promise","nodesToRemove","useProp","tokens","id","openIndex","closeIndex","testElem","nodeName","cStyle","renders","targetVal","_elCnt","_prv","_nxt","currentStyle","getComputedStyle","global","display","_jsvd","displayStyles","document","createElement","body","appendChild","removeChild","inline","nodes","transferViewTokens","_tgId","indexOf","length","disposeTokens","previousSibling","lastChild","remove","link","lazyLink","tagCtx","empty","children","textContent","innerText","arrayChangeHandler","self","action","index","items","addViews","removeViews","refresh","setArrayChangeLink","handler","arrayBinding","bound","bnd","useKey","bndArr","off","arrayChangeStr","arrVws","apply","arguments","on","linkGetVal","toLowerCase","$viewsSettings","merge","contentEditable","from","renderAndLink","views","context","html","linkToNode","prevView","bindId","elCnt","bnds","removeViewBinding","nextSibling","render","addBindingMarkers","tmplBindingKey","end","bindingKey","viewStore","l","linkedElem","exprFnDeps","cvtBk","convertBack","depends","_bndId","_hdl","_depends","_apply","fn","deps","$extend","bindTo","onAfterBind","flow","setAttribute","jsvAttrStr","getAttribute","radio","_jsvLkEl","tmplLink","noIteration","parentView","$link","tmplOrLinkTag","jquery","activeBody","elementChangeStr","i","k","vwInfos","placeholderParent","targetEl","topLevelCall","onRender","replaceMode","$view","topView","ctx","root","addDataBinding","markup","cleanData","lnk","viewInfos","rOpenViewMarkers","parent","key","viewLink","outerData","validateOnly","convertMarkers","all","preceding","selfClose","closeTag","spaceBefore","boundId","spaceAfter","tag1","tag2","closeTag2","spaceAfterClose","selfClose2","endOpenTag","errorMsg","bndId","endOfElCnt","inTag","isVoid","parentTag","tagStack","shift","validate","voidElems","join","syntaxError","prevElCnt","elContent","defer","ids","openScript","closeScript","deferStack","charAt","unshift","badParent","processViewInfos","targetParent","deferPath","deferChar","bindChar","onAftCr","deep","addedBindEls","_tkns","len","vwInfo","ch","j","open","push","onArrayChange","removeSubStr","onAfterCreate","bindEls","getViewInfos","level","named","tagDepth","tags","dataLink","wrap","selector","linkViewsSel","get","elems","qsa","querySelectorAll","innerHTML","prevNodes","found","markerNodeInfo","contains","isLink","rViewMarkers","skip","processInfos","$viewsLinkAttr","rOpenTagMarkers","unmarkPrevOrNextNode","resolve","prevIds","linkInfo","unlinked","token","nextView","node","depth","fragment","copiedNode","firstTag","wrapper","div","htmlTag","thisId","onAfterCreateStr","Deferred","name","noValidate","markPrevOrNextNode","namespaceURI","rFirstElem","noDomLevel0","replace","rConvertMarkers","safeFragment","wrapMap","createDocumentFragment","firstChild","insertBefore","setTimeout","linkMarkup","currentView","boundTagId","trimLen","tagExpr","rTagIndex","hasElse","linkExpressions","bindDataLinkTarget","normalizeLinkTag","rTagDatalink","lastIndex","isLk","delimCloseChar0","links","$sub","tmplFn","noArray","View","getContextCb","str","substr","SCRIPT","nodeType","isVal","rBinding","getInfos","close","elPath","infos","rMarkerTokens","removeAttribute","marker","twoway","trim","rEscapeQuotes","delimOpenChar1","$linkedElem","radioButtons","val","linkedTag","oldTrig","newTrig","onAfterLink","targetTag","noVal","cvtArgs","setSize","height","width","addClass","_jsvTr","trigger","bindElChange","asyncElemChangeHandler","$elem","trig","onoff","bindto","pathIndex","lastPath","bindtoOb","paths","_jsvto","split","newCtxs","newTagCtx","tagCtxs","_ths","clean","elemArray","linkedElemTag","objId","object","obsId","map","cbId","isArray","propertyChangeStr","unmap","onDispose","_cbBnds","$unlink","getElementsByTagName","each","innerView","tmplUnlink","rViewPath","inputAttrib","viewOrTagChar","viewOrTag","viewId","precedingLength","emptyView","vwItem","rOpenMarkers","observeProps","tgt","insert","observeMappedProps","item","src","removeProperty","shallowArrayFilter","allPath","requiresStr","observable","settings","delimOpenChar0","delimCloseChar1","linkChar","linkMethods","eval","sub","extend","isFunction","$converters","converters","$tags","$observe","observe","propChng","arrChng","syntaxErr","bindElsSel","input","text","valueBinding","isCleanCall","oldCleanData","oldJsvDelimiters","delimiters","querySelector","ol","ul","table","tbody","thead","tfoot","tr","colgroup","dl","select","optgroup","svg","svg_ns","br","img","hr","area","base","col","meta","command","embed","keygen","param","track","wbr","contents","filtered","filter","add","find","withMarkers","prevIsFirstNode","lastSibling","childTags","disposed","update","onStore","template","unlink","_tg","prototype","domChange","hasListener","hasData","_data","events","domChangeNotification","triggerHandler","delimChars","RegExp","rTag","dataItems","viewsCount","itemsCount","keepNodes","removeView","viewToRemove","current","splice","regularExpression","toggle","init","content","elemType","label","contextOb","activeElem","_evs","_sel","_hlr","concat","arrayView","targetLength","noVws","oldItems","done","arrHandler","arrBinding","arrayBindings","_ars","selected","tagCt","include","tci","prevArg","different","baseTag","dataMap","getTgt","obsSrc","obsTgt","tgtFlt","inner","getInnerView","nd","isVl","utility","message","oldFn","result","option","legend","td","support","htmlSerialize","linkAttr","textarea","jsrDbgMode","debugMode","_dbgMode","jsv","_err","caption","th"],"mappings":"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","file":"jquery.views.min.js","sourcesContent":["/*! JsViews v1.0.0-alpha: http://www.jsviews.com/#jsviews\r\ninformal pre V1.0 commit counter: 64 (Beta Candidate)*/\r\n/*\r\n * Interactive data-driven views using templates and data-linking.\r\n * Requires jQuery and jsrender.js (next-generation jQuery Templates, optimized for pure string-based rendering)\r\n *   See JsRender at http://www.jsviews.com/#download and http://github.com/BorisMoore/jsrender\r\n * Also requires jquery.observable.js\r\n *   See JsObservable at http://www.jsviews.com/#download and http://github.com/BorisMoore/jsviews\r\n\r\n * Copyright 2015, Boris Moore\r\n * Released under the MIT License.\r\n */\r\n\r\n//jshint -W018, -W041\r\n\r\n(function(factory) {\r\n\tif (typeof define === \"function\" && define.amd) {\r\n\t\t// Loading from AMD script loader. Register as an anonymous module.\r\n\t\tdefine([\"jquery\", \"./jsrender\", \"./jquery.observable\"], factory);\r\n\t} else {\r\n\t\t// Browser using plain <script> tag\r\n\t\tfactory(this.jQuery);\r\n\t}\r\n} (function($) {\r\n\t\"use strict\";\r\n\r\n\t//========================== Top-level vars ==========================\r\n\r\n\tvar versionNumber = \"v1.0.0-alpha\",\r\n\t\trequiresStr = \"JsViews requires \";\r\n\r\n\tif (!$) {\r\n\t\t// jQuery is not loaded.\r\n\t\tthrow requiresStr + \"jQuery\"; // We require jQuery\r\n\t}\r\n\r\n\tvar $views = $.views,\r\n\t\t$observable = $.observable;\r\n\r\n\tif (!$views || ! $views.settings) {\r\n\t\t// JsRender is not loaded.\r\n\t\tthrow requiresStr + \"JsRender\"; // jsrender.js must be loaded before JsViews and after jQuery\r\n\t}\r\n\r\n\tif (!$observable) {\r\n\t\t// JsObservable is not loaded.\r\n\t\tthrow requiresStr + \"JsObservable\"; // jquery.observable.js must be loaded before JsViews\r\n\t}\r\n\r\n\t// global is the this object, which is window when running in the usual browser environment.\r\n\tvar global = (0, eval)('this'), // jshint ignore:line\r\n\t\tdocument = global.document,\r\n\t\t$sub = $views.sub,\r\n\t\t$viewsSettings = $views.settings,\r\n\t\t$extend = $sub.extend,\r\n\t\t$isFunction = $.isFunction,\r\n\t\t$converters = $views.converters,\r\n\t\t$tags = $views.tags,\r\n\t\t$observe = $observable.observe,\r\n\r\n\t\t// These two settings can be overridden on settings after loading jsRender, and prior to loading jquery.observable.js and/or JsViews\r\n\t\tpropertyChangeStr = $sub.propChng = $sub.propChng || \"propertyChange\",\r\n\t\tarrayChangeStr = $sub.arrChng = $sub.arrChng || \"arrayChange\",\r\n\r\n\t\tHTML = \"html\",\r\n\t\tsyntaxError = $sub.syntaxErr,\r\n\t\trFirstElem = /<(?!script)(\\w+)(?:[^>]*(on\\w+)\\s*=)?[^>]*>/,\r\n\t\tdelimOpenChar0, delimOpenChar1, delimCloseChar0, delimCloseChar1, linkChar, error, topView,\r\n\t\trEscapeQuotes = /['\"\\\\]/g; // Escape quotes and \\ character\r\n\tvar activeBody, rTagDatalink, $view, $viewsLinkAttr, linkMethods, linkViewsSel, wrapMap, viewStore, noDomLevel0,\r\n\r\n\t\tjsvAttrStr = \"data-jsv\",\r\n\t\telementChangeStr = \"change.jsv\",\r\n\t\tonBeforeChangeStr = \"onBeforeChange\",\r\n\t\tonAfterChangeStr = \"onAfterChange\",\r\n\t\tonAfterCreateStr = \"onAfterCreate\",\r\n\t\tCHECKED = \"checked\",\r\n\t\tCHECKBOX = \"checkbox\",\r\n\t\tRADIO = \"radio\",\r\n\t\tNONE = \"none\",\r\n\t\tSCRIPT = \"SCRIPT\",\r\n\t\tTRUE = \"true\",\r\n\t\tcloseScript = '\"></script>',\r\n\t\topenScript = '<script type=\"jsv',\r\n\t\tdeferAttr = jsvAttrStr + \"-df\",\r\n\t\tbindElsSel = \"script,[\" + jsvAttrStr + \"]\",\r\n\t\tfnSetters = {\r\n\t\t\tvalue: \"val\",\r\n\t\t\tinput: \"val\",\r\n\t\t\thtml: HTML,\r\n\t\t\ttext: \"text\"\r\n\t\t},\r\n\t\tvalueBinding = {from: \"value\", to: \"value\"},\r\n\t\tisCleanCall = 0,\r\n\t\toldCleanData = $.cleanData,\r\n\t\toldJsvDelimiters = $viewsSettings.delimiters,\r\n\t\tsafeFragment = document.createDocumentFragment(),\r\n\t\tqsa = document.querySelector,\r\n\r\n\t\t// elContent maps tagNames which have only element content, so may not support script nodes.\r\n\t\telContent = {ol: 1, ul: 1, table: 1, tbody: 1, thead: 1, tfoot: 1, tr: 1, colgroup: 1, dl: 1, select: 1, optgroup: 1, svg: 1, svg_ns: 1},\r\n\t\tbadParent = {tr: \"table\"},\r\n\t\t// wrapMap provide appropriate wrappers for inserting innerHTML, used in insertBefore\r\n\t\t// We have to close these tags to support XHTML (#13200)\r\n\t\t// TODO investigate whether more recent jQuery implementation using wrapMap in domManip/$().html() etc. is better optimized now...\r\n\t\tvoidElems = {br: 1, img: 1, input: 1, hr: 1, area: 1, base: 1, col: 1, link: 1, meta: 1,\r\n\t\t\tcommand: 1, embed: 1, keygen: 1, param: 1, source: 1, track: 1, wbr: 1},\r\n\t\tdisplayStyles = {},\r\n\t\tbindingStore = {},\r\n\t\tbindingKey = 1,\r\n\t\trViewPath = /^#(view\\.?)?/,\r\n\t\trConvertMarkers = /(^|(\\/>)|<\\/(\\w+)>|)(\\s*)([#\\/]\\d+(?:_|(\\^)))`(\\s*)(<\\w+(?=[\\s\\/>]))?|\\s*(?:(<\\w+(?=[\\s\\/>]))|<\\/(\\w+)>(\\s*)|(\\/>)\\s*|(>))/g,\r\n\t\trOpenViewMarkers = /(#)()(\\d+)(_)/g,\r\n\t\trOpenMarkers = /(#)()(\\d+)([_^])/g,\r\n\t\trViewMarkers = /(?:(#)|(\\/))(\\d+)(_)/g,\r\n\t\trOpenTagMarkers = /(#)()(\\d+)(\\^)/g,\r\n\t\trMarkerTokens = /(?:(#)|(\\/))(\\d+)([_^])([-+@\\d]+)?/g,\r\n\t\tgetComputedStyle = global.getComputedStyle;\r\n\r\n\tif ($.link) { return $; } // JsViews is already loaded\r\n\r\n\t//========================== Top-level functions ==========================\r\n\r\n\t//===============\r\n\t// Event handlers\r\n\t//===============\r\n\r\n\tfunction elemChangeHandler(ev, params, sourceValue) {\r\n\t\tvar setter, cancel, fromAttr, linkCtx, cvtBack, cnvtName, target, $source, view, binding, oldLinkCtx, onBeforeChange, onAfterChange, tag, to, eventArgs, exprOb,\r\n\t\t\tsource = ev.target,\r\n\t\t\tbindings = source._jsvBnd,\r\n\t\t\tsplitBindings = /&(\\d+)\\+?/g;\r\n\r\n\t\t// _jsvBnd is a string with the syntax: \"&bindingId1&bindingId2\"\r\n\t\tif (bindings) {\r\n\t\t\twhile (binding = splitBindings.exec(bindings)) {\r\n\t\t\t\tif (binding = bindingStore[binding[1]]) {\r\n\t\t\t\t\tif (to = binding.to) {\r\n\t\t\t\t\t\t// The binding has a 'to' field, which is of the form [[targetObject, toPath], cvtBack]\r\n\t\t\t\t\t\tlinkCtx = binding.linkCtx;\r\n\t\t\t\t\t\tview = linkCtx.view;\r\n\t\t\t\t\t\ttag = linkCtx.tag;\r\n\t\t\t\t\t\t$source = $(source);\r\n\t\t\t\t\t\tonBeforeChange = view.hlp(onBeforeChangeStr); // TODO Can we optimize this and other instances of same?\r\n\t\t\t\t\t\tonAfterChange = view.hlp(onAfterChangeStr); // TODO Can we optimize this and other instances of same\r\n\t\t\t\t\t\tfromAttr = defaultAttr(source);\r\n\t\t\t\t\t\tsetter = fnSetters[fromAttr];\r\n\t\t\t\t\t\tif (sourceValue === undefined) {\r\n\t\t\t\t\t\t\tsourceValue = $isFunction(fromAttr)\r\n\t\t\t\t\t\t\t\t? fromAttr(source)\r\n\t\t\t\t\t\t\t\t: setter\r\n\t\t\t\t\t\t\t\t\t? $source[setter]()\r\n\t\t\t\t\t\t\t\t\t: $source.attr(fromAttr);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcnvtName = to[1];\r\n\t\t\t\t\t\tto = to[0]; // [object, path]\r\n\t\t\t\t\t\tto = to + \"\" === to ? [linkCtx.data, to] : to;\r\n\t\t\t\t\t\tif (cnvtName) {\r\n\t\t\t\t\t\t\tif ($isFunction(cnvtName)) {\r\n\t\t\t\t\t\t\t\tcvtBack = cnvtName;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tcvtBack = view.getRsc(\"converters\", cnvtName);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (cvtBack) {\r\n\t\t\t\t\t\t\tsourceValue = cvtBack.call(tag, sourceValue);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Set linkCtx on view, dynamically, just during this handler call\r\n\t\t\t\t\t\toldLinkCtx = view.linkCtx;\r\n\t\t\t\t\t\tview.linkCtx = linkCtx;\r\n\t\t\t\t\t\teventArgs = {\r\n\t\t\t\t\t\t\tchange: \"change\",\r\n\t\t\t\t\t\t\toldValue: linkCtx._val,\r\n\t\t\t\t\t\t\tvalue: sourceValue\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tif ((!onBeforeChange || !(cancel = onBeforeChange.call(linkCtx, ev, eventArgs) === false)) &&\r\n\t\t\t\t\t\t\t\t(!tag || !tag.onBeforeChange || !(cancel = tag.onBeforeChange(ev, eventArgs) === false)) &&\r\n\t\t\t\t\t\t\t\tsourceValue !== undefined) {\r\n\t\t\t\t\t\t\ttarget = to[0]; // [object, path]\r\n\t\t\t\t\t\t\tif (sourceValue !== undefined && target) {\r\n\t\t\t\t\t\t\t\tif (target._jsv) {\r\n\t\t\t\t\t\t\t\t\texprOb = target;\r\n\t\t\t\t\t\t\t\t\ttarget = linkCtx.data;\r\n\t\t\t\t\t\t\t\t\twhile (exprOb && exprOb.sb) {\r\n\t\t\t\t\t\t\t\t\t\ttarget = linkCtx._ctxCb(exprOb, target);\r\n\t\t\t\t\t\t\t\t\t\texprOb = exprOb.sb;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (tag) {\r\n\t\t\t\t\t\t\t\t\ttag._.chging = true; // marker to prevent tag change event triggering its own refresh\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t$observable(target).setProperty(to[2] || to[1], sourceValue);\r\n\t\t\t\t\t\t\t\tif (onAfterChange) {\r\n\t\t\t\t\t\t\t\t\tonAfterChange.call(linkCtx, ev, eventArgs);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (tag) {\r\n\t\t\t\t\t\t\t\t\tif (tag.onAfterChange) {\r\n\t\t\t\t\t\t\t\t\t\ttag.onAfterChange(ev, eventArgs);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\ttag._.chging = undefined; // clear the marker\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tlinkCtx._val = sourceValue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tview.linkCtx = oldLinkCtx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction propertyChangeHandler(ev, eventArgs, linkFn) {\r\n\t\tvar attr, sourceValue, noUpdate, forceUpdate, hasError, onError,\r\n\t\t\tlinkCtx = this,\r\n\t\t\ttag = linkCtx.tag,\r\n\t\t\tsource = linkCtx.data,\r\n\t\t\ttarget = linkCtx.elem,\r\n\t\t\tcvt = linkCtx.convert,\r\n\t\t\tparentElem = target.parentNode,\r\n\t\t\tview = linkCtx.view,\r\n\t\t\toldLinkCtx = view.linkCtx,\r\n\t\t\tonEvent = view.hlp(onBeforeChangeStr);\r\n\r\n\t\t// Set linkCtx on view, dynamically, just during this handler call\r\n\t\tview.linkCtx = linkCtx;\r\n\r\n\t\tif (parentElem && (!onEvent || !(eventArgs && onEvent.call(linkCtx, ev, eventArgs) === false))\r\n\t\t\t\t// If data changed, the ev.data is set to be the path. Use that to filter the handler action...\r\n\t\t\t\t&& !(eventArgs && ev.data.prop !== \"*\" && ev.data.prop !== eventArgs.path)) {\r\n\r\n\t\t\tif (eventArgs) {\r\n\t\t\t\tlinkCtx.eventArgs = eventArgs;\r\n\t\t\t}\r\n\t\t\tif (eventArgs || linkCtx._toLk) {\r\n\t\t\t\t// If eventArgs are defined, this is a data update\r\n\t\t\t\t// Otherwise this is the initial data-link rendering call. Bind on this the first time it get called\r\n\t\t\t\tlinkCtx._toLk = 0; // Remove flag to skip unneccessary rebinding next time\r\n\t\t\t\tif (linkFn._er) {\r\n\t\t\t\t\t// data-link=\"exprUsingTagOrCvt with onerror=...\" - e.g. {tag ... {cvt:... {:... convert='cvt'\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tsourceValue = linkFn(source, view);\r\n\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\thasError = linkFn._er;\r\n\t\t\t\t\t\tonError = error(e,view,(new Function(\"data,view\", \"return \" + hasError + \";\"))(source, view));\r\n\t\t\t\t\t\tsourceValue = [{props: {}, args: [onError]}];\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsourceValue = linkFn(source, view, $views);\r\n\t\t\t\t}\r\n\t\t\t\t// Compiled link expression for linkTag: return value for data-link=\"{:xxx}\" with no cvt or cvtBk, otherwise tagCtx or tagCtxs\r\n\r\n\t\t\t\tattr = getTargetVal(sourceValue, linkCtx, tag = linkCtx.tag,\r\n\t\t\t\t\t\tlinkCtx.attr || defaultAttr(target, true, cvt !== undefined)\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\tif (tag) {\r\n\t\t\t\t\t// Existing tag instance\r\n\t\t\t\t\tforceUpdate = hasError || tag._er;\r\n\t\t\t\t\t// If the new tagCtxs hasError or the previous tagCtxs had error, then force update\r\n\t\t\t\t\tsourceValue = sourceValue[0] ? sourceValue : [sourceValue];\r\n\t\t\t\t\tnoUpdate = !forceUpdate && eventArgs && tag.onUpdate && tag.onUpdate(ev, eventArgs, sourceValue) === false;\r\n\r\n\t\t\t\t\tmergeCtxs(tag, sourceValue, forceUpdate);\r\n\r\n\t\t\t\t\tif (noUpdate || attr === NONE) {\r\n\t\t\t\t\t\t// onUpdate returned false, or attr === \"none\", or this is an update coming from the tag's own change event\r\n\t\t\t\t\t\t// - so don't refresh the tag: we just use the new tagCtxs merged from the sourceValue,\r\n\t\t\t\t\t\t// (which may optionally have been modifed in onUpdate()...) and then bind, and we are done\r\n\t\t\t\t\t\tif (attr === HTML && tag.onBeforeLink) {\r\n\t\t\t\t\t\t\ttag.onBeforeLink();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcallAfterLink(tag);\r\n\t\t\t\t\t\tobserveAndBind(linkCtx, source, target);\r\n\t\t\t\t\t\tview.linkCtx = oldLinkCtx;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (tag._.chging) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tsourceValue = tag.tagName === \":\" // Call convertVal if it is a {{cvt:...}} - otherwise call renderTag\r\n\t\t\t\t\t\t? $views._cnvt(tag.cvt, view, sourceValue[0])\r\n\t\t\t\t\t\t: $views._tag(tag, view, view.tmpl, sourceValue, true, onError);\r\n\t\t\t\t} else if (linkFn._tag) {\r\n\t\t\t\t\t// For {{: ...}} without a convert or convertBack, we already have the sourceValue, and we are done\r\n\t\t\t\t\t// For {{: ...}} with either cvt or cvtBack we call convertVal to get the sourceValue and instantiate the tag\r\n\t\t\t\t\t// If cvt is undefined then this is a tag, and we call renderTag to get the rendered content and instantiate the tag\r\n\t\t\t\t\tcvt = cvt === \"\" ? TRUE : cvt; // If there is a cvtBack but no cvt, set cvt to \"true\"\r\n\t\t\t\t\tsourceValue = cvt // Call convertVal if it is a {{cvt:...}} - otherwise call renderTag\r\n\t\t\t\t\t\t? $views._cnvt(cvt, view, sourceValue[0] || sourceValue) // convertVal\r\n\t\t\t\t\t\t: $views._tag(linkFn._tag, view, view.tmpl, sourceValue, true, onError); // renderTag\r\n\r\n\t\t\t\t\ttag = linkCtx.tag; // In both convertVal and renderTag we have instantiated a tag\r\n\t\t\t\t\tattr = linkCtx.attr || attr; // linkCtx.attr may have been set to tag.attr during tag instantiation in renderTag\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (updateContent(sourceValue, linkCtx, attr, tag)\r\n\t\t\t\t\t\t&& eventArgs\r\n\t\t\t\t\t\t&& (onEvent = view.hlp(onAfterChangeStr))) {\r\n\t\t\t\t\tonEvent.call(linkCtx, ev, eventArgs);\r\n\t\t\t\t}\r\n\t\t\t\tlinkCtx._noUpd = 0; // For data-link=\"^{...}\" remove _noUpd flag so updates on subsequent calls\r\n\r\n\t\t\t\tif (tag) {\r\n\t\t\t\t\ttag._er = hasError;\r\n\t\t\t\t\tcallAfterLink(tag, eventArgs);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tobserveAndBind(linkCtx, source, target);\r\n\r\n\t\t\t// Remove dynamically added linkCtx from view\r\n\t\t\tview.linkCtx = oldLinkCtx;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction getTargetVal(sourceValue, linkCtx, tag, attr) {\r\n\t\tvar currentValue, setter, css, $target,\r\n\t\t\ttarget = tag && tag.parentElem || linkCtx.elem;\r\n\r\n\t\tif (sourceValue !== undefined) {\r\n\t\t\t$target = $(target);\r\n\t\t\tattr = tag && tag.attr || attr;\r\n\t\t\tif ($isFunction(sourceValue)) {\r\n\t\t\t\terror(linkCtx.expr + \": missing parens\");\r\n\t\t\t}\r\n\r\n\t\t\tif (css = /^css-/.test(attr) && attr.slice(4)) {\r\n\t\t\t\tcurrentValue = $.style(target, css);\r\n\t\t\t\tif (+sourceValue === sourceValue) {\r\n\t\t\t\t\t// Optimization for perf on integer values - e.g. css-width{:width+'px'}\r\n\t\t\t\t\tcurrentValue = parseInt(currentValue);\r\n\t\t\t\t}\r\n\t\t\t} else if (attr !== \"link\") { // attr === \"link\" is for tag controls which do data binding but have no rendered output or target\r\n\t\t\t\tif (attr === \"value\") {\r\n\t\t\t\t\tif (target.type === CHECKBOX) {\r\n\t\t\t\t\t\tcurrentValue = $target.prop(attr = CHECKED);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (attr === RADIO) {\r\n\t\t\t\t\tif (target.value === (\"\" + sourceValue)) {\r\n\t\t\t\t\t\tcurrentValue = $target.prop(CHECKED);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn attr;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (currentValue === undefined) {\r\n\t\t\t\t\tsetter = fnSetters[attr];\r\n\t\t\t\t\tcurrentValue = setter ? $target[setter]() : $target.attr(attr);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlinkCtx._val = currentValue;\r\n\t\t}\r\n\t\treturn attr;\r\n\t}\r\n\r\n\tfunction setDefer(elem, value) {\r\n\t\telem._df = value; // Use both an expando and an attribute to track defered tokens. Attribute is needed for querySelectorAll for getViewInfos (childTags)\r\n\t\telem[(value ? \"set\" : \"remove\") + \"Attribute\"](deferAttr, \"\");\r\n\t}\r\n\r\n\tfunction updateContent(sourceValue, linkCtx, attr, tag) {\r\n\t\t// When called for a tag, either in tag.refresh() or propertyChangeHandler(), returns a promise (and supports async)\r\n\t\t// When called (in propertyChangeHandler) for target HTML returns true\r\n\t\t// When called (in propertyChangeHandler) for other targets returns boolean for \"changed\"\r\n\t\tvar setter, prevNode, nextNode, promise, nodesToRemove, useProp, tokens, id, openIndex, closeIndex, testElem, nodeName, cStyle,\r\n\t\t\trenders = sourceValue !== undefined && !linkCtx._noUpd, // For data-link=\"^{...}\", don't update the first time (no initial render) - e.g. to leave server rendered values.\r\n\t\t\tsource = linkCtx.data,\r\n\t\t\ttarget = tag && tag.parentElem || linkCtx.elem,\r\n\t\t\t$target = $(target),\r\n\t\t\tview = linkCtx.view,\r\n\t\t\ttargetVal = linkCtx._val,\r\n\t\t\toldLinkCtx = view.linkCtx,\r\n\t\t\t// If not a tag and not targeting HTML, we can use the ._val obtained from getTargetVal()\r\n\t\t\t// and only update when the new value (sourceValue) has changed from the previous one\r\n\t\t\tchange = tag || attr === HTML;\r\n\r\n\t\tif (tag) {\r\n\t\t\t// Initialize the tag with element references\r\n\t\t\ttag.parentElem = tag.parentElem || (linkCtx.expr || tag._elCnt) ? target : target.parentNode;\r\n\t\t\tprevNode = tag._prv;\r\n\t\t\tnextNode = tag._nxt;\r\n\t\t}\r\n\t\tif (!renders) {\r\n\t\t\tif (attr === HTML && tag && tag.onBeforeLink) {\r\n\t\t\t\ttag.onBeforeLink();\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (attr === \"visible\") {\r\n\t\t\tattr = \"css-display\";\r\n\t\t}\r\n\t\tif (/^css-/.test(attr)) {\r\n\t\t\tif (linkCtx.attr === \"visible\") {\r\n\t\t\t\t// Get the current display style\r\n\t\t\t\tcStyle = (target.currentStyle || getComputedStyle.call(global, target, \"\")).display;\r\n\r\n\t\t\t\tif (sourceValue) {\r\n\t\t\t\t\t// We are showing the element.\r\n\t\t\t\t\t// Get the cached 'visible' display value from the -jsvd expando\r\n\t\t\t\t\tsourceValue = target._jsvd\r\n\t\t\t\t\t\t// Or, if not yet cached, get the current display value\r\n\t\t\t\t\t\t|| cStyle;\r\n\t\t\t\t\tif (sourceValue === NONE && !(sourceValue = displayStyles[nodeName = target.nodeName])) {\r\n\t\t\t\t\t\t// Currently display value is 'none', and the 'visible' style has not been cached.\r\n\t\t\t\t\t\t// We create an element to find the correct 'visible' display style for this nodeName\r\n\t\t\t\t\t\ttestElem = document.createElement(nodeName);\r\n\t\t\t\t\t\tdocument.body.appendChild(testElem);\r\n\r\n\t\t\t\t\t\t// Get the default style for this HTML tag to use as 'visible' style\r\n\t\t\t\t\t\tsourceValue\r\n\t\t\t\t\t\t\t// and cache it as a hash against nodeName\r\n\t\t\t\t\t\t\t= displayStyles[nodeName]\r\n\t\t\t\t\t\t\t= (testElem.currentStyle || getComputedStyle.call(global, testElem, \"\")).display;\r\n\t\t\t\t\t\tdocument.body.removeChild(testElem);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// We are hiding the element.\r\n\t\t\t\t\t// Cache the current display value as 'visible' style, on _jsvd expando, for when we show the element again\r\n\t\t\t\t\ttarget._jsvd = cStyle;\r\n\t\t\t\t\tsourceValue = NONE; // Hide the element\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (change = change || targetVal !== sourceValue) {\r\n\t\t\t\t$.style(target, attr.slice(4), sourceValue);\r\n\t\t\t}\r\n\t\t} else if (/^data-/.test(attr)) {\r\n\t\t\t$.data(target, attr.slice(5), sourceValue);\r\n\t\t} else if (attr !== \"link\") { // attr === \"link\" is for tag controls which do data binding but have no rendered output or target\r\n\t\t\tif (attr === CHECKED) {\r\n\t\t\t\tuseProp = true;\r\n\t\t\t\tsourceValue = sourceValue && sourceValue !== \"false\";\r\n\t\t\t\t// The string value \"false\" can occur with data-link=\"checked{attr:expr}\" - as a result of attr, and hence using convertVal()\r\n\t\t\t\t// We will set the \"checked\" property\r\n\t\t\t\t// We will compare this with the current value\r\n\t\t\t} else if (attr === RADIO) {\r\n\t\t\t\t// This is a special binding attribute for radio buttons, which corresponds to the default 'to' binding.\r\n\t\t\t\t// This allows binding both to value (for each input) and to the default checked radio button (for each input in named group,\r\n\t\t\t\t// e.g. binding to parent data).\r\n\t\t\t\t// Place value binding first: <input type=\"radio\" data-link=\"value{:name} {:#get('data').data.currency:} \" .../>\r\n\t\t\t\t// or (allowing any order for the binding expressions):\r\n\t\t\t\t// <input type=\"radio\" value=\"{{:name}}\" data-link=\"{:#get('data').data.currency:} value^{:name}\" .../>\r\n\r\n\t\t\t\tif (target.value === (\"\" + sourceValue)) {\r\n\t\t\t\t\t// If the data value corresponds to the value attribute of this radio button input, set the checked property to true\r\n\t\t\t\t\tsourceValue = useProp = true;\r\n\t\t\t\t\tattr = CHECKED;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Otherwise, go straight to observeAndBind, without updating.\r\n\t\t\t\t\t// (The browser will remove the 'checked' attribute, when another radio button in the group is checked).\r\n\t\t\t\t\tobserveAndBind(linkCtx, source, target);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t} else if (attr === \"selected\" || attr === \"disabled\" || attr === \"multiple\" || attr === \"readonly\") {\r\n\t\t\t\tsourceValue = (sourceValue && sourceValue !== \"false\") ? attr : null;\r\n\t\t\t\t// Use attr, not prop, so when the options (for example) are changed dynamically, but include the previously selected value,\r\n\t\t\t\t// they will still be selected after the change\r\n\t\t\t}\r\n\r\n\t\t\tif (setter = fnSetters[attr]) {\r\n\t\t\t\tif (attr === HTML) {\r\n\t\t\t\t\t// Set linkCtx on view, dynamically, just during this handler call\r\n\t\t\t\t\tview.linkCtx = linkCtx;\r\n\t\t\t\t\tif (tag && tag._.inline) {\r\n\t\t\t\t\t\tnodesToRemove = tag.nodes(true);\r\n\t\t\t\t\t\tif (tag._elCnt) {\r\n\t\t\t\t\t\t\tif (prevNode && prevNode !== nextNode) {\r\n\t\t\t\t\t\t\t\t// This prevNode will be removed from the DOM, so transfer the view tokens on prevNode to nextNode of this 'viewToRefresh'\r\n\t\t\t\t\t\t\t\ttransferViewTokens(prevNode, nextNode, target, tag._tgId, \"^\", true);\r\n\t\t\t\t\t\t\t} else if (tokens = target._df) { // This occurs when there is no nextNode, and so the target._df may include tokens referencing\r\n\t\t\t\t\t\t\t\t// view and tag bindings contained within the open and close tokens of the updated tag control. They need to be processed (disposed)\r\n\t\t\t\t\t\t\t\tid = tag._tgId + \"^\";\r\n\t\t\t\t\t\t\t\topenIndex = tokens.indexOf(\"#\" + id) + 1;\r\n\t\t\t\t\t\t\t\tcloseIndex = tokens.indexOf(\"/\" + id);\r\n\r\n\t\t\t\t\t\t\t\tif (openIndex && closeIndex > 0) {\r\n\t\t\t\t\t\t\t\t\topenIndex += id.length;\r\n\t\t\t\t\t\t\t\t\tif (closeIndex > openIndex) {\r\n\t\t\t\t\t\t\t\t\t\tsetDefer(target, tokens.slice(0, openIndex) + tokens.slice(closeIndex));\r\n\t\t\t\t\t\t\t\t\t\tdisposeTokens(tokens.slice(openIndex, closeIndex));\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tprevNode = prevNode\r\n\t\t\t\t\t\t\t\t? prevNode.previousSibling\r\n\t\t\t\t\t\t\t\t: nextNode\r\n\t\t\t\t\t\t\t\t\t? nextNode.previousSibling\r\n\t\t\t\t\t\t\t\t\t: target.lastChild;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Remove HTML nodes\r\n\t\t\t\t\t\t$(nodesToRemove).remove(); // Note if !tag._elCnt removing the nodesToRemove will process and dispose view and tag bindings contained within the updated tag control\r\n\r\n\t\t\t\t\t\tif (tag && tag.onBeforeLink) {\r\n\t\t\t\t\t\t\ttag.onBeforeLink();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Insert and link new content\r\n\t\t\t\t\t\tpromise = view.link(view.data, target, prevNode, nextNode, sourceValue, tag && {tag: tag._tgId, lazyLink: tag.tagCtx.props.lazyLink});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// data-linked value targeting innerHTML: data-link=\"html{:expr}\"\r\n\t\t\t\t\t\tif (renders) {\r\n\t\t\t\t\t\t\t$target.empty();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (tag && tag.onBeforeLink) {\r\n\t\t\t\t\t\t\ttag.onBeforeLink();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (renders) {\r\n\t\t\t\t\t\t\tpromise = view.link(source, target, prevNode, nextNode, sourceValue, tag && {tag: tag._tgId});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Remove dynamically added linkCtx and ctx from view\r\n\t\t\t\t\tview.linkCtx = oldLinkCtx;\r\n\t\t\t\t} else if (change = change || targetVal !== sourceValue) {\r\n\t\t\t\t\tif (attr === \"text\" && target.children && !target.children[0]) {\r\n\t\t\t\t\t\t// This code is faster then $target.text()\r\n\t\t\t\t\t\tif (target.textContent !== undefined) {\r\n\t\t\t\t\t\t\ttarget.textContent = sourceValue;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttarget.innerText = sourceValue === null ? \"\" : sourceValue;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$target[setter](sourceValue);\r\n\t\t\t\t\t}\r\n// Removing this for now, to avoid side-effects when you programmatically set the value, and want the focus to stay on the text box\r\n//\t\t\t\t\t\t\tif (target.nodeName.toLowerCase() === \"input\") {\r\n//\t\t\t\t\t\t\t\t$target.blur(); // Issue with IE. This ensures HTML rendering is updated.\r\n//\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// Data link the new contents of the target node\r\n\t\t\t\t}\r\n\t\t\t} else if (change = change || targetVal !== sourceValue) {\r\n\t\t\t\t// Setting an attribute to undefined should remove the attribute\r\n\t\t\t\t$target[useProp ? \"prop\" : \"attr\"](attr, sourceValue === undefined && !useProp ? null : sourceValue);\r\n\t\t\t}\r\n\t\t\tlinkCtx._val = sourceValue;\r\n\t\t}\r\n\t\treturn promise || change;\r\n\t}\r\n\r\n\tfunction arrayChangeHandler(ev, eventArgs) {\r\n\t\tvar self = this,\r\n\t\t\tonBeforeChange = self.hlp(onBeforeChangeStr),\r\n\t\t\tonAfterChange = self.hlp(onAfterChangeStr);\r\n\t\tif (!onBeforeChange || onBeforeChange.call(this, ev, eventArgs) !== false) {\r\n\t\t\tif (eventArgs) {\r\n\t\t\t\t// This is an observable action (not a trigger/handler call from pushValues, or similar, for which eventArgs will be null)\r\n\t\t\t\tvar action = eventArgs.change,\r\n\t\t\t\t\tindex = eventArgs.index,\r\n\t\t\t\t\titems = eventArgs.items;\r\n\r\n\t\t\t\tswitch (action) {\r\n\t\t\t\t\tcase \"insert\":\r\n\t\t\t\t\t\tself.addViews(index, items);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"remove\":\r\n\t\t\t\t\t\tself.removeViews(index, items.length);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"move\":\r\n\t\t\t\t\t\tself.refresh(); // Could optimize this\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"refresh\":\r\n\t\t\t\t\t\tself.refresh();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t// Other cases: (e.g.undefined, for setProperty on observable object) etc. do nothing\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (onAfterChange) {\r\n\t\t\t\tonAfterChange.call(this, ev, eventArgs);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//=============================\r\n\t// Utilities for event handlers\r\n\t//=============================\r\n\r\n\tfunction setArrayChangeLink(view) {\r\n\t\t// Add/remove arrayChange handler on view\r\n\t\tvar handler, arrayBinding,\r\n\t\t\ttype = view.type, // undefined if view is being removed\r\n\t\t\tdata = view.data,\r\n\t\t\tbound = view._.bnd; // true for top-level link() or data-link=\"{for}\", or the for tag instance for {^{for}} (or for any custom tag that has an onArrayChange handler)\r\n\r\n\t\tif (!view._.useKey && bound) {\r\n\t\t\t// This is an array view. (view._.useKey not defined => data is array), and is data-bound to collection change events\r\n\r\n\t\t\tif (arrayBinding = view._.bndArr) {\r\n\t\t\t\t// First remove the current handler if there is one\r\n\t\t\t\t$([arrayBinding[1]]).off(arrayChangeStr, arrayBinding[0]);\r\n\t\t\t\tview._.bndArr = undefined;\r\n\t\t\t}\r\n\t\t\tif (bound !== !!bound) {\r\n\t\t\t\t// bound is not a boolean, so it is the data-linked tag that 'owns' this array binding - e.g. {^{for...}}\r\n\t\t\t\tif (type) {\r\n\t\t\t\t\tbound._.arrVws[view._.id] = view;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdelete bound._.arrVws[view._.id]; // if view.type is undefined, view is being removed\r\n\t\t\t\t}\r\n\t\t\t} else if (type && data) {\r\n\t\t\t\t// If this view is not being removed, but the data array has been replaced, then bind to the new data array\r\n\t\t\t\thandler = function(ev) {\r\n\t\t\t\t\tif (!(ev.data && ev.data.off)) {\r\n\t\t\t\t\t\t// Skip if !!ev.data.off: - a handler that has already been removed (maybe was on handler collection at call time - then removed by another handler)\r\n\t\t\t\t\t\t// If view.type is undefined, do nothing. (Corresponds to case where there is another handler on the same data whose\r\n\t\t\t\t\t\t// effect was to remove this view, and which happened to precede this event in the trigger sequence. So although this\r\n\t\t\t\t\t\t// event has been removed now, it is still called since already on the trigger sequence)\r\n\t\t\t\t\t\tarrayChangeHandler.apply(view, arguments);\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\t$([data]).on(arrayChangeStr, handler);\r\n\t\t\t\tview._.bndArr = [handler, data];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction defaultAttr(elem, to, linkGetVal) {\r\n\t\t// to: true - default attribute for setting data value on HTML element; false: default attribute for getting value from HTML element\r\n\t\t// Merge in the default attribute bindings for this target element\r\n\t\tvar nodeName = elem.nodeName.toLowerCase(),\r\n\t\t\tattr =\r\n\t\t\t\t$viewsSettings.merge[nodeName] // get attr settings for input textarea select or optgroup\r\n\t\t\t\t|| elem.contentEditable === TRUE && {to: HTML, from: HTML}; // Or if contentEditable set to \"true\" set attr to \"html\"\r\n\t\treturn attr\r\n\t\t\t? (to\r\n\t\t\t\t? ((nodeName === \"input\" && elem.type === RADIO) // For radio buttons, bind from value, but bind to 'radio' - special value.\r\n\t\t\t\t\t? RADIO\r\n\t\t\t\t\t: attr.to)\r\n\t\t\t\t: attr.from)\r\n\t\t\t: to\r\n\t\t\t\t? linkGetVal ? \"text\" : HTML // Default innerText for data-link=\"a.b.c\" or data-link=\"{:a.b.c}\" (with or without converters)- otherwise innerHTML\r\n\t\t\t\t: \"\"; // Default is not to bind from\r\n\t}\r\n\r\n\t//==============================\r\n\t// Rendering and DOM insertion\r\n\t//==============================\r\n\r\n\tfunction renderAndLink(view, index, tmpl, views, data, context, refresh) {\r\n\t\tvar html, linkToNode, prevView, nodesToRemove, bindId,\r\n\t\t\tparentNode = view.parentElem,\r\n\t\t\tprevNode = view._prv,\r\n\t\t\tnextNode = view._nxt,\r\n\t\t\telCnt = view._elCnt;\r\n\r\n\t\tif (prevNode && prevNode.parentNode !== parentNode) {\r\n\t\t\terror(\"Missing parentNode\");\r\n\t\t\t// Abandon, since node has already been removed, or wrapper element has been inserted between prevNode and parentNode\r\n\t\t}\r\n\r\n\t\tif (refresh) {\r\n\t\t\tnodesToRemove = view.nodes();\r\n\t\t\tif (elCnt && prevNode && prevNode !== nextNode) {\r\n\t\t\t\t// This prevNode will be removed from the DOM, so transfer the view tokens on prevNode to nextNode of this 'viewToRefresh'\r\n\t\t\t\ttransferViewTokens(prevNode, nextNode, parentNode, view._.id, \"_\", true);\r\n\t\t\t}\r\n\t\t\t// Remove child views\r\n\t\t\tview.removeViews(undefined, undefined, true);\r\n\t\t\tlinkToNode = nextNode;\r\n\r\n\t\t\tif (elCnt) {\r\n\t\t\t\tprevNode = prevNode\r\n\t\t\t\t\t? prevNode.previousSibling\r\n\t\t\t\t\t: nextNode\r\n\t\t\t\t\t\t? nextNode.previousSibling\r\n\t\t\t\t\t\t: parentNode.lastChild;\r\n\t\t\t}\r\n\r\n\t\t\t// Remove HTML nodes\r\n\t\t\t$(nodesToRemove).remove();\r\n\r\n\t\t\tfor (bindId in view._.bnds) {\r\n\t\t\t\t// The view bindings may have already been removed above in: $(nodesToRemove).remove();\r\n\t\t\t\t// If not, remove them here:\r\n\t\t\t\tremoveViewBinding(bindId);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// addViews. Only called if view is of type \"array\"\r\n\t\t\tif (index) {\r\n\t\t\t\t// index is a number, so indexed view in view array\r\n\t\t\t\tprevView = views[index - 1];\r\n\t\t\t\tif (!prevView) {\r\n\t\t\t\t\treturn false; // If subview for provided index does not exist, do nothing\r\n\t\t\t\t}\r\n\t\t\t\tprevNode = prevView._nxt;\r\n\t\t\t}\r\n\t\t\tif (elCnt) {\r\n\t\t\t\tlinkToNode = prevNode;\r\n\t\t\t\tprevNode = linkToNode\r\n\t\t\t\t\t? linkToNode.previousSibling         // There is a linkToNode, so insert after previousSibling, or at the beginning\r\n\t\t\t\t\t: parentNode.lastChild;              // If no prevView and no prevNode, index is 0 and the container is empty,\r\n\t\t\t\t\t// so prevNode = linkToNode = null. But if prevView._nxt is null then we set prevNode to parentNode.lastChild\r\n\t\t\t\t\t// (which must be before the prevView) so we insert after that node - and only link the inserted nodes\r\n\t\t\t} else {\r\n\t\t\t\tlinkToNode = prevNode.nextSibling;\r\n\t\t\t}\r\n\t\t}\r\n\t\thtml = tmpl.render(data, context, view._.useKey && refresh, view, refresh || index, true);\r\n\t\t// Pass in view._.useKey as test for noIteration (which corresponds to when self._.useKey > 0 and self.data is an array)\r\n\r\n\t\t// Link the new HTML nodes to the data\r\n\t\tview.link(data, parentNode, prevNode, linkToNode, html, prevView);\r\n//}, 0);\r\n\t}\r\n\r\n\t//=====================\r\n\t// addBindingMarkers\r\n\t//=====================\r\n\r\n\tfunction addBindingMarkers(value, view, tmplBindingKey) {\r\n\t\t// Insert binding markers into the rendered template output, which will get converted to appropriate\r\n\t\t// data-jsv attributes (element-only content) or script marker nodes (phrasing or flow content), in convertMarkers,\r\n\t\t// within view.link, prior to inserting into the DOM. Linking will then bind based on these markers in the DOM.\r\n\t\t// Added view markers: #m_...VIEW.../m_\r\n\t\t// Added tag markers: #m^...TAG..../m^\r\n\t\tvar id, tag, end;\r\n\t\tif (tmplBindingKey) {\r\n\t\t\t// This is a binding marker for a data-linked tag {^{...}}\r\n\t\t\tend = \"^`\";\r\n\t\t\ttag = view._.tag; // This is {^{>...}} or {^{tag ...}}, {{cvt:...} or {^{:...}}, and tag was defined in convertVal or renderTag\r\n\t\t\tid = tag._tgId;\r\n\t\t\tif (!id) {\r\n\t\t\t\tbindingStore[id = bindingKey++] = tag; // Store the tag temporarily, ready for databinding.\r\n\t\t\t\t// During linking, in addDataBinding, the tag will be attached to the linkCtx,\r\n\t\t\t\t// and then in observeAndBind, bindingStore[bindId] will be replaced by binding info.\r\n\t\t\t\ttag._tgId = \"\" + id;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// This is a binding marker for a view\r\n\t\t\t// Add the view to the store of current linked views\r\n\t\t\tend = \"_`\";\r\n\t\t\tviewStore[id = view._.id] = view;\r\n\t\t}\r\n\t\t// Example: \"#23^TheValue/23^\"\r\n\t\treturn \"#\" + id + end\r\n\t\t\t+ (value != undefined ? value : \"\") // For {^{:name}} this gives the equivalent semantics to compiled\r\n\t\t\t\t\t\t\t\t\t\t\t\t// (v=data.name)!=null?v:\"\"; used in {{:name}} or data-link=\"name\"\r\n\t\t\t+ \"/\" + id + end;\r\n\t}\r\n\r\n\t//==============================\r\n\t// Data-linking and data binding\r\n\t//==============================\r\n\r\n\t//---------------\r\n\t// observeAndBind\r\n\t//---------------\r\n\r\n\tfunction observeAndBind(linkCtx, source, target) { //TODO? linkFnArgs) {;\r\n\t\tvar binding, l, linkedElem, exprFnDeps, exprOb,\r\n\t\t\ttag = linkCtx.tag,\r\n\t\t\tcvtBk = linkCtx.convertBack,\r\n\t\t\tdepends = [],\r\n\t\t\tbindId = linkCtx._bndId || \"\" + bindingKey++,\r\n\t\t\thandler = linkCtx._hdl;\r\n\r\n\t\tlinkCtx._bndId = undefined;\r\n\r\n\t\tif (tag) {\r\n\t\t\t// Use the 'depends' paths set on linkCtx.tag - which may have been set on declaration\r\n\t\t\t// or in events: init, render, onBeforeLink, onAfterLink etc.\r\n\t\t\tdepends = tag.depends || depends;\r\n\t\t\tdepends = $isFunction(depends) ? tag.depends(tag) : depends;\r\n\t\t\tlinkedElem = tag.linkedElem;\r\n\t\t}\r\n\t\tif (!linkCtx._depends || (\"\" + linkCtx._depends !== \"\" + depends)) {\r\n\t\t\t// Only bind the first time, or if the new depends (toString) has changed from when last bound\r\n\t\t\tif (linkCtx._depends) {\r\n\t\t\t\t// Unobserve previous binding\r\n\t\t\t\t$observable._apply(false, [source], linkCtx._depends, handler, true);\r\n\t\t\t}\r\n\r\n\t\t\texprFnDeps = linkCtx.fn.deps.slice(); // Make a copy of the dependency paths for the compiled linkCtx expression - to pass to observe(). In getInnerCb(),\r\n\t\t\t// (and whenever the object is updated, in innerCb), we will set exprOb.ob to the current object returned by that computed expression, for this view.\r\n\t\t\tl = exprFnDeps.length;\r\n\t\t\twhile (l--) {\r\n\t\t\t\texprOb = exprFnDeps[l];\r\n\t\t\t\tif (exprOb._jsv) {\r\n\t\t\t\t\t// This path is an 'exprOb', corresponding to a computed, returning an object. We replace the exprOb by\r\n\t\t\t\t\t// a view-binding-specific exprOb instance. The current object will be stored as exprOb.ob.\r\n\t\t\t\t\texprFnDeps[l] = $extend({}, exprOb);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbinding = $observable._apply(\r\n\t\t\t\tfalse,\r\n\t\t\t\t[source],\r\n\t\t\t\texprFnDeps, // flatten the paths - to gather all the dependencies across args and bound params\r\n\t\t\t\tdepends,\r\n\t\t\t\thandler,\r\n\t\t\t\tlinkCtx._ctxCb);\r\n\t\t\t// The binding returned by $observe has a bnd array with the source objects of the individual bindings.\r\n\r\n\t\t\tbinding.elem = target; // The target of all the individual bindings\r\n\t\t\tbinding.linkCtx = linkCtx;\r\n\t\t\tbinding._tgId = bindId;\r\n\r\n\t\t\t// Add to the _jsvBnd on the target the view id and binding id - for unbinding when the target element is removed\r\n\t\t\ttarget._jsvBnd = target._jsvBnd || \"\";\r\n\t\t\ttarget._jsvBnd += \"&\" + bindId;\r\n\t\t\tlinkCtx._depends = depends;\r\n\t\t\t// Store the binding key on the view, for disposal when the view is removed\r\n\t\t\tlinkCtx.view._.bnds[bindId] = bindId;\r\n\t\t\t// Store the binding.\r\n\t\t\tbindingStore[bindId] = binding; // Note: If this corresponds to a data-linked tag, we are replacing the\r\n\t\t\t// temporarily stored tag by the stored binding. The tag will now be at binding.linkCtx.tag\r\n\r\n\t\t\tif (linkedElem) {\r\n\t\t\t\tbinding.to = [[], cvtBk];\r\n\t\t\t}\r\n\t\t\tif (linkedElem || cvtBk !== undefined) {\r\n\t\t\t\tbindTo(binding, tag && tag.convertBack || cvtBk);\r\n\t\t\t}\r\n\t\t\tif (tag) {\r\n\t\t\t\tif (tag.onAfterBind) {\r\n\t\t\t\t\ttag.onAfterBind(binding);\r\n\t\t\t\t}\r\n\t\t\t\tif (!tag.flow && !tag._.inline) {\r\n\t\t\t\t\ttarget.setAttribute(jsvAttrStr, (target.getAttribute(jsvAttrStr)||\"\") + \"#\" + bindId + \"^/\" + bindId + \"^\");\r\n\t\t\t\t\ttag._tgId = \"\" + bindId;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (linkedElem && linkedElem[0]) {\r\n\t\t\tif (tag._.radio) {\r\n\t\t\t\tlinkedElem = linkedElem.children(\"input[type=radio]\");\r\n\t\t\t}\r\n\r\n\t\t\tl = linkedElem.length;\r\n\t\t\twhile (l--) {\r\n\t\t\t\tlinkedElem[l]._jsvBnd = linkedElem[l]._jsvBnd || (target._jsvBnd + \"+\");\r\n\t\t\t\t// Add a \"+\" for cloned binding - so removing elems with cloned bindings will not remove the 'parent' binding from the bindingStore.\r\n\t\t\t\tlinkedElem[l]._jsvLkEl = tag;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//-------\r\n\t// $.link\r\n\t//-------\r\n\r\n\tfunction tmplLink(to, from, context, noIteration, parentView, prevNode, nextNode) {\r\n\t\treturn $link(this, to, from, context, noIteration, parentView, prevNode, nextNode);\r\n\t}\r\n\r\n\tfunction $link(tmplOrLinkTag, to, from, context, noIteration, parentView, prevNode, nextNode) {\r\n\t\t// When linking from a template, prevNode and nextNode parameters are ignored\r\n\r\n\t\t// Consider supporting this: $.link(true, data) - (top-level activation) target defaults to body.\r\n\t\t// But with templates, defaulting to body makes less sense, so not support for now...\r\n\t\t\t//if (to + \"\" !== to) {\r\n\t\t\t// nextNode = prevNode;\r\n\t\t\t// prevNode = parentView;\r\n\t\t\t// parentView = context;\r\n\t\t\t// context = from;\r\n\t\t\t// from = to;\r\n\t\t\t// to = \"body\";\r\n\t\t\t//}\r\n\t\tif (context === true) {\r\n\t\t\tnoIteration = context; // passing boolean as third param - noIteration\r\n\t\t\tcontext = undefined;\r\n\t\t} else if (typeof context !== \"object\") {\r\n\t\t\tcontext = undefined; // context must be a boolean (noIteration) or a plain object\r\n\t\t}\r\n\t\tif (tmplOrLinkTag && to) {\r\n\t\t\tto = to.jquery ? to : $(to); // to is a jquery object or an element or selector\r\n\r\n\t\t\tif (!activeBody) {\r\n\t\t\t\tactiveBody = document.body;\r\n\t\t\t\t$(activeBody)\r\n\t\t\t\t\t.on(elementChangeStr, elemChangeHandler)\r\n\t\t\t\t\t.on('blur', '[contenteditable]', elemChangeHandler);\r\n\t\t\t}\r\n\r\n\t\t\tvar i, k, html, vwInfos, view, placeholderParent, targetEl, refresh, topLevelCall,\r\n\t\t\t\tonRender = addBindingMarkers,\r\n\t\t\t\treplaceMode = context && context.target === \"replace\",\r\n\t\t\t\tl = to.length;\r\n\r\n\t\t\twhile (l--) {\r\n\t\t\t\ttargetEl = to[l];\r\n\r\n\t\t\t\tparentView = parentView || $view(targetEl);\r\n\r\n\t\t\t\tif (topLevelCall = parentView === topView) {\r\n\t\t\t\t\ttopView.data = (topView.ctx = context || {}).root = from;\r\n\t\t\t\t}\r\n\t\t\t\tif (\"\" + tmplOrLinkTag === tmplOrLinkTag) {\r\n\t\t\t\t\t// tmplOrLinkTag is a string: treat as data-link expression.\r\n\t\t\t\t\taddDataBinding(tmplOrLinkTag, targetEl, parentView, undefined, true, from, context);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (tmplOrLinkTag.markup !== undefined) {\r\n\t\t\t\t\t\t// This is a call to template.link()\r\n\t\t\t\t\t\tif (parentView.link === false) {\r\n\t\t\t\t\t\t\tcontext = context || {};\r\n\t\t\t\t\t\t\tcontext.link = onRender = false; // If link=false, don't allow nested context to switch on linking\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Set link=false, explicitly, to disable linking within a template nested within a linked template\r\n\t\t\t\t\t\tif (replaceMode) {\r\n\t\t\t\t\t\t\tplaceholderParent = targetEl.parentNode;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\thtml = tmplOrLinkTag.render(from, context, noIteration, parentView, undefined, onRender);\r\n\t\t\t\t\t\t// TODO Consider finding a way to bind data (link) within template without html being different for each view, the HTML can\r\n\t\t\t\t\t\t// be evaluated once outside the while (l--), and pushed into a document fragment, then cloned and inserted at each target.\r\n\r\n\t\t\t\t\t\tif (placeholderParent) {\r\n\t\t\t\t\t\t\t// This is target=\"replace\" mode\r\n\t\t\t\t\t\t\tprevNode = targetEl.previousSibling;\r\n\t\t\t\t\t\t\tnextNode = targetEl.nextSibling;\r\n\t\t\t\t\t\t\t$.cleanData([targetEl], true);\r\n\t\t\t\t\t\t\tplaceholderParent.removeChild(targetEl);\r\n\r\n\t\t\t\t\t\t\ttargetEl = placeholderParent;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tprevNode = nextNode = undefined; // When linking from a template, prevNode and nextNode parameters are ignored\r\n\t\t\t\t\t\t\t$(targetEl).empty();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (tmplOrLinkTag === true && parentView === topView) {\r\n\t\t\t\t\t\t// $.link(true, selector, data, ctx) - where selector points to elem in top-level content\r\n\t\t\t\t\t\trefresh = {lnk: 1};\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\r\n// TODO Consider deferred linking API feature on per-template basis - {@{ instead of {^{ which allows the user to see the rendered content\r\n// before that content is linked, with better perceived perf. Have view.link return a deferred, and pass that to onAfterLink...\r\n// or something along those lines.\r\n// setTimeout(function() {\r\n\r\n\t\t\t\t\tif (targetEl._df && !nextNode) {\r\n\t\t\t\t\t\t// We are inserting new content and the target element has some deferred binding annotations,and there is no nextNode.\r\n\t\t\t\t\t\t// Those views may be stale views (that will be recreated in this new linking action) so we will first remove them\r\n\t\t\t\t\t\t// (if not already removed).\r\n\t\t\t\t\t\tvwInfos = viewInfos(targetEl._df, true, rOpenViewMarkers);\r\n\r\n\t\t\t\t\t\tfor (i = 0, k = vwInfos.length; i < k; i++) {\r\n\t\t\t\t\t\t\tview = vwInfos[i];\r\n\t\t\t\t\t\t\tif ((view = viewStore[view.id]) && view.data !== undefined) {\r\n\t\t\t\t\t\t\t\t// If this is the _prv (prevNode) for a view, remove the view\r\n\t\t\t\t\t\t\t\t// - unless view.data is undefined, in which case it is already being removed\r\n\t\t\t\t\t\t\t\tview.parent.removeViews(view._.key, undefined, true);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsetDefer(targetEl); // remove defer tokens\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Link the content of the element, since this is a call to template.link(), or to $(el).link(true, ...),\r\n\t\t\t\t\tparentView.link(from, targetEl, prevNode, nextNode, html, refresh, context);\r\n//}, 0);\r\n\t\t\t\t}\r\n\t\t\t\tif (topLevelCall) {\r\n\t\t\t\t\ttopView.data = topView.ctx = undefined;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn to; // Allow chaining, to attach event handlers, etc.\r\n\t}\r\n\r\n\t//----------\r\n\t// view.link\r\n\t//----------\r\n\r\n\tfunction viewLink(outerData, parentNode, prevNode, nextNode, html, refresh, context, validateOnly) {\r\n\t\t// Optionally insert HTML into DOM using documentFragments (and wrapping HTML appropriately).\r\n\t\t// Data-link existing contents of parentNode, or the inserted HTML, if provided\r\n\r\n\t\t// Depending on the content model for the HTML elements, the standard data-linking markers inserted in the HTML by addBindingMarkers during\r\n\t\t// template rendering will be converted either to script marker nodes or, for element-only content sections, to data-jsv element annotations.\r\n\r\n\t\t// Data-linking will then add _prv and _nxt to views, where:\r\n\t\t//     _prv: References the previous node (script element of type \"jsv123\"), or (for elCnt=true), the first element node in the view (or if none, set _prv = _nxt)\r\n\t\t//     _nxt: References the last node (script element of type \"jsv/123\"), or (for elCnt=true), the next element node after the view.\r\n\r\n\t\t//==== nested functions ====\r\n\t\tfunction convertMarkers(all, preceding, selfClose, closeTag, spaceBefore, id, boundId, spaceAfter, tag1, tag2, closeTag2, spaceAfterClose, selfClose2, endOpenTag) {\r\n\t\t\t// rConvertMarkers = /(^|(\\/>)|<\\/(\\w+)>|)(\\s*)([#\\/]\\d+(?:_|(\\^)))`(\\s*)(<\\w+(?=[\\s\\/>]))?|\\s*(?:(<\\w+(?=[\\s\\/>]))|<\\/(\\w+)>(\\s*)|(\\/>)\\s*|(>))/g,\r\n\t\t\t//                 prec, slfCl, clsTag,  spBefore, id,      bndId  spAfter,tag1,                   tag2,               clTag2,sac  slfCl2, endOpenTag\r\n\t\t\t// Convert the markers that were included by addBindingMarkers in template output, to appropriate DOM annotations:\r\n\t\t\t// data-jsv attributes (for element-only content) or script marker nodes (within phrasing or flow content).\r\n\r\n// TODO consider detecting 'quoted' contexts (attribute strings) so that attribute encoding does not need to encode >\r\n// Currently rAttrEncode = /[><\"'&]/g includes '>' encoding in order to avoid erroneous parsing of <span title=\"&lt;a/>\"></span>\">\r\n\t\t\tvar errorMsg, bndId,\r\n\t\t\t\tendOfElCnt = \"\";\r\n\t\t\tif (endOpenTag) {\r\n\t\t\t\tinTag = 0;\r\n\t\t\t\treturn all;\r\n\t\t\t}\r\n\t\t\ttag = tag1 || tag2 || \"\";\r\n\t\t\tcloseTag = closeTag || closeTag2;\r\n\t\t\tselfClose = selfClose || selfClose2;\r\n\t\t\tif (isVoid && !selfClose && ( !all || closeTag || tag || id && !inTag)) { // !all = end of string\r\n\t\t\t\tisVoid = undefined;\r\n\t\t\t\tparentTag = tagStack.shift(); // preceding tag was a void element, with no closing slash, such as <br>.\r\n\t\t\t}\r\n\t\t\tcloseTag = closeTag || selfClose;\r\n\t\t\tif (closeTag) {\r\n\t\t\t\tinTag = 0;\r\n\t\t\t\tisVoid = undefined;\r\n\t\t\t\t// TODO: smart insertion of <tbody> - to be completed for robust insertion of deferred bindings etc.\r\n\t\t\t\t//if (closeTag === \"table\" && parentTag === \"tbody\") {\r\n\t\t\t\t//\tpreceding = \"</tbody>\" + preceding;\r\n\t\t\t\t//\tparentTag = \"table\";\r\n\t\t\t\t//\ttagStack.shift();\r\n\t\t\t\t//}\r\n\t\t\t\tif (validate) {\r\n\t\t\t\t\tif (selfClose || selfClose2) {\r\n\t\t\t\t\t\tif (!voidElems[parentTag] && !/;svg;|;math;/.test(\";\" + tagStack.join(\";\") + \";\")) {\r\n\t\t\t\t\t\t\t// Only self-closing elements must be legitimate void elements, such as <br/>, per HTML schema,\r\n\t\t\t\t\t\t\t// or under svg or math foreign namespace elements.\r\n\t\t\t\t\t\t\terrorMsg = \"'<\" + parentTag + \".../\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (voidElems[closeTag]) {\r\n\t\t\t\t\t\terrorMsg = \"'</\" + closeTag; // closing tag such as </input>\r\n\t\t\t\t\t} else if (!tagStack.length || closeTag !== parentTag) {\r\n\t\t\t\t\t\terrorMsg = \"Mismatch: '</\" + closeTag;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (errorMsg) {\r\n\t\t\t\t\t\tsyntaxError(errorMsg + \">' in:\\n\" + html);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tprevElCnt = elCnt;\r\n\t\t\t\tparentTag = tagStack.shift();\r\n\t\t\t\telCnt = elContent[parentTag];\r\n\t\t\t\tcloseTag2 = closeTag2 ? (\"</\" + closeTag2 + \">\") : \"\";\r\n\t\t\t\tif (prevElCnt) {\r\n\t\t\t\t\t// If there are ids (markers since the last tag), move them to the defer string\r\n\t\t\t\t\tdefer += ids;\r\n\t\t\t\t\tids = \"\";\r\n\t\t\t\t\tif (!elCnt) {\r\n\t\t\t\t\t\tendOfElCnt = closeTag2 + openScript + \"@\" + defer + closeScript + (spaceAfterClose || \"\");\r\n\t\t\t\t\t\tdefer = deferStack.shift();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdefer += \"-\"; // Will be used for stepping back through deferred tokens\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (elCnt) {\r\n\t\t\t\t// elContent maps tagNames which have only element content, so may not support script nodes.\r\n\t\t\t\t// We are in element-only content, can remove white space, and use data-jsv attributes on elements as markers\r\n\t\t\t\t// Example: <tr data-jsv=\"/2_#6_\"> - close marker for view 2 and open marker for view 6\r\n\r\n\t\t\t\tif (id) {\r\n\t\t\t\t\t// append marker for this id, to ids string\r\n\t\t\t\t\tids += id;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpreceding = (closeTag2 || selfClose2 || \"\");\r\n\t\t\t\t}\r\n\t\t\t\tif (tag) {\r\n\t\t\t\t\t// TODO: smart insertion of <tbody> - to be completed for robust insertion of deferred bindings etc.\r\n\t\t\t\t\t//if (tag === \"<tr\" && parentTag === \"table\") {\r\n\t\t\t\t\t//\ttagStack.unshift(parentTag);\r\n\t\t\t\t\t//\tparentTag = \"tbody\";\r\n\t\t\t\t\t//\tpreceding += \"<\" + parentTag + \">\";\r\n\t\t\t\t\t//\tif (defer) {\r\n\t\t\t\t\t//\t\tdefer += \"+\"; // Will be used for stepping back through deferred tokens\r\n\t\t\t\t\t//\t}\r\n\t\t\t\t\t//\t// TODO: move this to design-time validation check\r\n\t\t\t\t\t//\t//\terror('\"' + parentTag + '\" has incorrect parent tag');\r\n\t\t\t\t\t//}\r\n\t\t\t\t\tpreceding += tag;\r\n\t\t\t\t\tif (ids) {\r\n\t\t\t\t\t\tpreceding += ' ' + jsvAttrStr + '=\"' + ids + '\"';\r\n\t\t\t\t\t\tids = \"\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// We are in phrasing or flow content, so use script marker nodes\r\n\t\t\t\t// Example: <script type=\"jsv3/\"></script> - data-linked tag, close marker\r\n\t\t\t\t// TODO add validation to track whether we are in attribute context (not yet hit preceding ending with a >) or element content of current 'parentTag'\r\n\t\t\t\t// and accordingly disallow inserting script markers in attribute context. Similar for elCnt too, so no \"<table {{if ...}}...{{/if}}... >\" or \"<table {{if ...}}...> ...{{/if}}...\"\r\n\t\t\t\t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       preceding = id\r\n\t\t\t\t\t? (preceding + endOfElCnt + spaceBefore + (inTag ? \"\" : openScript + id + closeScript)+ spaceAfter + tag)\r\n\t\t\t\t\t: endOfElCnt || all;\r\n\t\t\t}\r\n\r\n\t\t\tif (validate && boundId) {\r\n\t\t\t\tif (inTag) {\r\n\t\t\t\t\t// JsViews data-linking tags are not allowed within element markup.\r\n\t\t\t\t\t// See https://github.com/BorisMoore/jsviews/issues/303\r\n\t\t\t\t\tsyntaxError('{^{ within elem markup (' + inTag + ' ). Use data-link=\"...\"');\r\n\t\t\t\t}\r\n\t\t\t\tif (id.charAt(0) === \"#\") {\r\n\t\t\t\t\ttagStack.unshift(id.slice(1));\r\n\t\t\t\t} else if (id.slice(1) !== (bndId = tagStack.shift())) {\r\n\t\t\t\t\t// See https://github.com/BorisMoore/jsviews/issues/213\r\n\t\t\t\t\tsyntaxError('Closing tag for {^{...}} under different elem: <' + bndId + '>');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (tag) {\r\n\t\t\t\tinTag = tag;\r\n\t\t\t\t// If there are ids (markers since the last tag), move them to the defer string\r\n\t\t\t\ttagStack.unshift(parentTag);\r\n\t\t\t\tparentTag = tag.slice(1);\r\n\t\t\t\tif (tagStack[0] && tagStack[0] === badParent[parentTag]) {\r\n\t\t\t\t\t// Missing <tbody>\r\n\t\t\t\t\t// TODO: replace this by smart insertion of <tbody> tags\r\n\t\t\t\t\terror('Parent of <tr> must be <tbody>');\r\n\t\t\t\t}\r\n\t\t\t\tisVoid = voidElems[parentTag];\r\n\t\t\t\tif ((elCnt = elContent[parentTag]) && !prevElCnt) {\r\n\t\t\t\t\tdeferStack.unshift(defer);\r\n\t\t\t\t\tdefer = \"\";\r\n\t\t\t\t}\r\n\t\t\t\tprevElCnt = elCnt;\r\n//TODO Consider providing validation which throws if you place <span> as child of <tr>, etc. - since if not caught,\r\n//this can cause errors subsequently which are difficult to debug.\r\n//\t\t\t\tif (elContent[tagStack[0]]>2 && !elCnt) {\r\n//\t\t\t\t\terror(parentTag + \" in \" + tagStack[0]);\r\n//\t\t\t\t}\r\n\t\t\t\tif (defer && elCnt) {\r\n\t\t\t\t\tdefer += \"+\"; // Will be used for stepping back through deferred tokens\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn preceding;\r\n\t\t}\r\n\r\n\t\tfunction processViewInfos(vwInfos, targetParent) {\r\n\t\t\t// If targetParent, we are processing viewInfos (which may include navigation through '+-' paths) and hooking up to the right parentElem etc.\r\n\t\t\t// (and elem may also be defined - the next node)\r\n\t\t\t// If no targetParent, then we are processing viewInfos on newly inserted content\r\n\t\t\tvar deferPath, deferChar, bindChar, parentElem, id, onAftCr, deep,\r\n\t\t\t\taddedBindEls = [];\r\n\r\n\t\t\t// In elCnt context (element-only content model), prevNode is the first node after the open, nextNode is the first node after the close.\r\n\t\t\t// If both are null/undefined, then open and close are at end of parent content, so the view is empty, and its placeholder is the\r\n\t\t\t// 'lastChild' of the parentNode. If there is a prevNode, then it is either the first node in the view, or the view is empty and\r\n\t\t\t// its placeholder is the 'previousSibling' of the prevNode, which is also the nextNode.\r\n\t\t\tif (vwInfos) {\r\n\t\t\t\tif (vwInfos._tkns.charAt(0) === \"@\") {\r\n\t\t\t\t\t// We are processing newly inserted content. This is a special script element that was created in convertMarkers() to process deferred bindings,\r\n\t\t\t\t\t// and inserted following the target parent element - because no element tags (outside elCnt) were encountered to carry those binding tokens.\r\n\t\t\t\t\t// We will step back from the preceding sibling of this element, looking at targetParent elements until we find the one that the current binding\r\n\t\t\t\t\t// token belongs to. Set elem to null (the special script element), and remove it from the DOM.\r\n\t\t\t\t\ttargetParent = elem.previousSibling;\r\n\t\t\t\t\telem.parentNode.removeChild(elem);\r\n\t\t\t\t\telem = undefined;\r\n\t\t\t\t}\r\n\t\t\t\tlen = vwInfos.length;\r\n\t\t\t\twhile (len--) {\r\n\t\t\t\t\tvwInfo = vwInfos[len];\r\n//if (prevIds.indexOf(vwInfo.token) < 0) { // This token is a newly created view or tag binding\r\n\t\t\t\t\tbindChar = vwInfo.ch;\r\n\t\t\t\t\tif (deferPath = vwInfo.path) {\r\n\t\t\t\t\t\t// We have a 'deferred path'\r\n\t\t\t\t\t\tj = deferPath.length - 1;\r\n\t\t\t\t\t\twhile (deferChar = deferPath.charAt(j--)) {\r\n\t\t\t\t\t\t\t// Use the \"+\" and\"-\" characters to navigate the path back to the original parent node where the deferred bindings ocurred\r\n\t\t\t\t\t\t\tif (deferChar === \"+\") {\r\n\t\t\t\t\t\t\t\tif (deferPath.charAt(j) === \"-\") {\r\n\t\t\t\t\t\t\t\t\tj--;\r\n\t\t\t\t\t\t\t\t\ttargetParent = targetParent.previousSibling;\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\ttargetParent = targetParent.parentNode;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\ttargetParent = targetParent.lastChild;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// Note: Can use previousSibling and lastChild, not previousElementSibling and lastElementChild,\r\n\t\t\t\t\t\t\t// since we have removed white space within elCnt. Hence support IE < 9\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (bindChar === \"^\") {\r\n\t\t\t\t\t\tif (tag = bindingStore[id = vwInfo.id]) {\r\n\t\t\t\t\t\t\t// The binding may have been deleted, for example in a different handler to an array collectionChange event\r\n\t\t\t\t\t\t\t// This is a tag binding\r\n\t\t\t\t\t\t\tdeep = targetParent && (!elem || elem.parentNode !== targetParent); // We are stepping back looking for the right targetParent,\r\n\t\t\t\t\t\t\t// or we are linking existing content and this element is in elCnt, not an immediate child of the targetParent.\r\n\t\t\t\t\t\t\tif (!elem || deep) {\r\n\t\t\t\t\t\t\t\ttag.parentElem = targetParent;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (vwInfo.elCnt && deep) {\r\n\t\t\t\t\t\t\t\t// With element only content, if there is no following element, or if the binding is deeper than the following element\r\n\t\t\t\t\t\t\t\t// then we need to set the open or close token as a deferred binding annotation on the parent\r\n\t\t\t\t\t\t\t\tsetDefer(targetParent, (vwInfo.open ? \"#\" : \"/\") + id + bindChar + (targetParent._df || \"\"));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// This is an open or close marker for a data-linked tag {^{...}}. Add it to bindEls.\r\n\t\t\t\t\t\t\taddedBindEls.push([deep ? null : elem, vwInfo]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (view = viewStore[id = vwInfo.id]) {\r\n\t\t\t\t\t\t// The view may have been deleted, for example in a different handler to an array collectionChange event\r\n\t\t\t\t\t\tif (!view.parentElem) {\r\n\t\t\t\t\t\t\t// If view is not already extended for JsViews, extend and initialize the view object created in JsRender, as a JsViews view\r\n\t\t\t\t\t\t\tview.parentElem = targetParent || elem && elem.parentNode || parentNode;\r\n\t\t\t\t\t\t\tview._.onRender = addBindingMarkers;\r\n\t\t\t\t\t\t\tview._.onArrayChange = arrayChangeHandler;\r\n\t\t\t\t\t\t\tsetArrayChangeLink(view);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tparentElem = view.parentElem;\r\n\t\t\t\t\t\tif (vwInfo.open) {\r\n\t\t\t\t\t\t\t// This is an 'open view' node (preceding script marker node,\r\n\t\t\t\t\t\t\t// or if elCnt, the first element in the view, with a data-jsv annotation) for binding\r\n\t\t\t\t\t\t\tview._elCnt = vwInfo.elCnt;\r\n\t\t\t\t\t\t\tif (targetParent && !elem) {\r\n\t\t\t\t\t\t\t\tsetDefer(targetParent, \"#\" + id + bindChar + (targetParent._df || \"\"));\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t// No targetParent, so there is a ._nxt elem (and this is processing tokens on the elem)\r\n\t\t\t\t\t\t\t\tif (!view._prv) {\r\n\t\t\t\t\t\t\t\t\tsetDefer(parentElem, removeSubStr(parentElem._df, \"#\" + id + bindChar));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tview._prv = elem;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// This is a 'close view' marker node for binding\r\n\t\t\t\t\t\t\tif (targetParent && (!elem || elem.parentNode !== targetParent)) {\r\n\t\t\t\t\t\t\t\t// There is no ._nxt so add token to _df. It is deferred.\r\n\t\t\t\t\t\t\t\tsetDefer(targetParent, \"/\" + id + bindChar + (targetParent._df || \"\"));\r\n\t\t\t\t\t\t\t\tview._nxt = undefined;\r\n\t\t\t\t\t\t\t} else if (elem) {\r\n\t\t\t\t\t\t\t\t// This view did not have a ._nxt, but has one now, so token may be in _df, and must be removed. (No longer deferred)\r\n\t\t\t\t\t\t\t\tif (!view._nxt) {\r\n\t\t\t\t\t\t\t\t\tsetDefer(parentElem, removeSubStr(parentElem._df, \"/\" + id + bindChar));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tview._nxt = elem;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tlinkCtx = view.linkCtx;\r\n\t\t\t\t\t\t\tif (onAftCr = view.ctx && view.ctx.onAfterCreate || onAfterCreate) {\r\n\t\t\t\t\t\t\t\tonAftCr.call(linkCtx, view);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n//}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tlen = addedBindEls.length;\r\n\t\t\t\twhile (len--) {\r\n\t\t\t\t\t// These were added in reverse order to addedBindEls. We push them in BindEls in the correct order.\r\n\t\t\t\t\tbindEls.push(addedBindEls[len]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn !vwInfos || vwInfos.elCnt;\r\n\t\t}\r\n\r\n\t\tfunction getViewInfos(vwInfos) {\r\n\t\t\t// Used by view.childTags() and tag.childTags()\r\n\t\t\t// Similar to processViewInfos in how it steps through bindings to find tags. Only finds data-linked tags.\r\n\t\t\tvar level, parentTag, named;\r\n\r\n\t\t\tif (vwInfos) {\r\n\t\t\t\tlen = vwInfos.length;\r\n\t\t\t\tfor (j = 0; j < len; j++) {\r\n\t\t\t\t\tvwInfo = vwInfos[j];\r\n\t\t\t\t\t// This is an open marker for a data-linked tag {^{...}}, within the content of the tag whose id is get.id. Add it to bindEls.\r\n\t\t\t\t\t// Note - if bindingStore[vwInfo.id]._is === \"tag\" then getViewInfos is being called too soon - during first linking pass\r\n\t\t\t\t\tparentTag = tag = bindingStore[vwInfo.id].linkCtx.tag;\r\n\t\t\t\t\tnamed = tag.tagName === tagName;\r\n\t\t\t\t\tif (!tag.flow || named) {\r\n\t\t\t\t\t\tif (!deep) {\r\n\t\t\t\t\t\t\tlevel = 1;\r\n\t\t\t\t\t\t\twhile (parentTag = parentTag.parent) {\r\n\t\t\t\t\t\t\t\tlevel++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ttagDepth = tagDepth || level; // The level of the first tag encountered.\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ((deep || level === tagDepth) && (!tagName || named)) {\r\n\t\t\t\t\t\t\t// Filter on top-level or tagName as appropriate\r\n\t\t\t\t\t\t\ttags.push(tag);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction dataLink() {\r\n\t\t\t//================ Data-link and fixup of data-jsv annotations ================\r\n\t\t\tvar j, index,\r\n\t\t\t\ttokens = \"\",\r\n\t\t\t\twrap = {},\r\n\t\t\t\tselector = linkViewsSel + (get ? \",[\" + deferAttr + \"]\" : \"\");\r\n\t\t\t\t// If a childTags() call, get = \",[\" + deferAttr + \"]\" - since we need to include elements that have a ._df expando for deferred tokens\r\n\r\n\t\t\telems = qsa ? parentNode.querySelectorAll(selector) : $(selector, parentNode).get();\r\n\t\t\tl = elems.length;\r\n\r\n\t\t\t// The prevNode will be in the returned query, since we called markPrevOrNextNode() on it.\r\n\t\t\t// But it may have contained nodes that satisfy the selector also.\r\n\t\t\tif (prevNode && prevNode.innerHTML) {\r\n\t\t\t\t// Find the last contained node of prevNode, to use as the prevNode - so we only link subsequent elems in the query\r\n\t\t\t\tprevNodes = qsa ? prevNode.querySelectorAll(selector) : $(selector, prevNode).get();\r\n\t\t\t\tprevNode = prevNodes.length ? prevNodes[prevNodes.length - 1] : prevNode;\r\n\t\t\t}\r\n\r\n\t\t\ttagDepth = 0;\r\n\t\t\tfor (i = 0; i < l; i++) {\r\n\t\t\t\telem = elems[i];\r\n\t\t\t\tif (prevNode && !found) {\r\n\t\t\t\t\t// If prevNode is set, not false, skip linking. If this element is the prevNode, set to false so subsequent elements will link.\r\n\t\t\t\t\tfound = (elem === prevNode);\r\n\t\t\t\t} else if (nextNode && elem === nextNode) {\r\n\t\t\t\t\t// If nextNode is set then break when we get to nextNode\r\n\t\t\t\t\tif (get) {\r\n\t\t\t\t\t\ttokens += markerNodeInfo(elem);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t} else if (elem.parentNode) {\r\n\t\t\t\t\t// elem has not been removed from DOM\r\n\t\t\t\t\tif (get) {\r\n\t\t\t\t\t\ttokens += markerNodeInfo(elem);\r\n\t\t\t\t\t\tif (elem._df) {\r\n\t\t\t\t\t\t\tj = i + 1;\r\n\t\t\t\t\t\t\twhile (j < l && elem.contains(elems[j])) {\r\n\t\t\t\t\t\t\t\tj++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// Add defered tokens after any tokens on descendant elements of this one\r\n\t\t\t\t\t\t\twrap[j-1] = elem._df;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (wrap[i]) {\r\n\t\t\t\t\t\t\ttokens += wrap[i] || \"\";\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (isLink && (vwInfo = viewInfos(elem, undefined, rViewMarkers)) && (vwInfo = vwInfo[0])) {\r\n\t\t\t\t\t\t\t// If this is a link(trueOrString ...) call we will avoid re-binding to elems that are within template-rendered views\r\n\t\t\t\t\t\t\tskip = skip ? (vwInfo.id !== skip && skip) : vwInfo.open && vwInfo.id;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!skip && processInfos(viewInfos(elem))\r\n\t\t\t\t\t\t\t// If a link() call, processViewInfos() adds bindings to bindEls, and returns true for non-script nodes, for adding data-link bindings\r\n\t\t\t\t\t\t\t// If a childTags() call, getViewInfos returns array of tag bindings.\r\n\t\t\t\t\t\t\t\t&& elem.getAttribute($viewsLinkAttr)) {\r\n\t\t\t\t\t\t\tbindEls.push([elem]); // A data-linked element so add to bindEls too\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (get) {\r\n\t\t\t\ttokens += parentNode._df || \"\";\r\n\t\t\t\tif (index = tokens.indexOf(\"#\" + get.id) + 1) {\r\n\t\t\t\t\t// We are looking for view.childTags() or tag.childTags() - so start after the open token of the parent view or tag.\r\n\t\t\t\t\ttokens = tokens.slice(index + get.id.length);\r\n\t\t\t\t}\r\n\t\t\t\tindex = tokens.indexOf(\"/\" + get.id);\r\n\t\t\t\tif (index + 1) {\r\n\t\t\t\t\t// We are looking for view.childTags() or tag.childTags() - so don't look beyond the close token of the parent view or tag.\r\n\t\t\t\t\ttokens = tokens.slice(0, index);\r\n\t\t\t\t}\r\n\t\t\t\t// Call getViewInfos to add the found childTags to the tags array\r\n\t\t\t\tgetViewInfos(viewInfos(tokens, undefined, rOpenTagMarkers));\r\n\t\t\t}\r\n\r\n\t\t\tif (html === undefined && parentNode.getAttribute($viewsLinkAttr)) {\r\n\t\t\t\tbindEls.push([parentNode]); // Support data-linking top-level element directly (not within a data-linked container)\r\n\t\t\t}\r\n\r\n\t\t\t// Remove temporary marker script nodes they were added by markPrevOrNextNode\r\n\t\t\tunmarkPrevOrNextNode(prevNode, elCnt);\r\n\t\t\tunmarkPrevOrNextNode(nextNode, elCnt);\r\n\r\n\t\t\tif (get) {\r\n\t\t\t\tif (lazyLink) {\r\n\t\t\t\t\tlazyLink.resolve();\r\n\t\t\t\t}\r\n\t\t\t\treturn; // We have added childTags to the tags array, so we are done\r\n\t\t\t}\r\n\r\n\t\t\tif (elCnt && defer + ids) {\r\n\t\t\t\t// There are some views with elCnt, for which the open or close did not precede any HTML tag - so they have not been processed yet\r\n\t\t\t\telem = nextNode;\r\n\t\t\t\tif (defer) {\r\n\t\t\t\t\tif (nextNode) {\r\n\t\t\t\t\t\tprocessViewInfos(viewInfos(defer + \"+\", true), nextNode);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tprocessViewInfos(viewInfos(defer, true), parentNode);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tprocessViewInfos(viewInfos(ids, true), parentNode);\r\n\t\t\t\t// If there were any tokens on nextNode which have now been associated with inserted HTML tags, remove them from nextNode\r\n\t\t\t\tif (nextNode) {\r\n\t\t\t\t\ttokens = nextNode.getAttribute(jsvAttrStr);\r\n\t\t\t\t\tif (l = tokens.indexOf(prevIds) + 1) {\r\n\t\t\t\t\t\ttokens = tokens.slice(l + prevIds.length - 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnextNode.setAttribute(jsvAttrStr, ids + tokens);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//================ Bind the data-linked elements and tags ================\r\n\t\t\tl = bindEls.length;\r\n\t\t\tfor (i = 0; i < l; i++) {\r\n\t\t\t\telem = bindEls[i];\r\n\t\t\t\tlinkInfo = elem[1];\r\n\t\t\t\telem = elem[0];\r\n\t\t\t\tif (linkInfo) {\r\n\t\t\t\t\tif (tag = bindingStore[linkInfo.id]) {\r\n\t\t\t\t\t\tif (linkCtx = tag.linkCtx) {\r\n\t\t\t\t\t\t\t// The tag may have been stored temporarily on the bindingStore - or may have already been replaced by the actual binding\r\n\t\t\t\t\t\t\ttag = linkCtx.tag;\r\n\t\t\t\t\t\t\ttag.linkCtx = linkCtx;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (linkInfo.open) {\r\n\t\t\t\t\t\t\t// This is an 'open linked tag' binding annotation for a data-linked tag {^{...}}\r\n\t\t\t\t\t\t\tif (elem) {\r\n\t\t\t\t\t\t\t\ttag.parentElem = elem.parentNode;\r\n\t\t\t\t\t\t\t\ttag._prv = elem;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ttag._elCnt = linkInfo.elCnt;\r\n\t\t\t\t\t\t\tif (tag.onBeforeLink) {\r\n\t\t\t\t\t\t\t\ttag.onBeforeLink();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// We data-link depth-last (\"on the way in\"), which is better for perf - and allows setting parent tags etc.\r\n\t\t\t\t\t\t\tview = tag.tagCtx.view;\r\n\t\t\t\t\t\t\taddDataBinding(undefined, tag._prv, view, linkInfo.id);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttag._nxt = elem;\r\n\t\t\t\t\t\t\tif (tag._.unlinked) {\r\n\t\t\t\t\t\t\t\t// This is a 'close linked tag' binding annotation\r\n\t\t\t\t\t\t\t\t// Add data binding\r\n\t\t\t\t\t\t\t\ttagCtx = tag.tagCtx;\r\n\t\t\t\t\t\t\t\tview = tagCtx.view;\r\n\t\t\t\t\t\t\t\tcallAfterLink(tag);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Add data binding for a data-linked element (with data-link attribute)\r\n\t\t\t\t\taddDataBinding(elem.getAttribute($viewsLinkAttr), elem, $view(elem), undefined, isLink, outerData, context);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (lazyLink) {\r\n\t\t\t\tlazyLink.resolve();\r\n\t\t\t}\r\n\t\t}\r\n\t\t//==== /end of nested functions ====\r\n\r\n\t\tvar inTag, linkCtx, tag, i, l, j, len, elems, elem, view, vwInfo, linkInfo, prevNodes, token, prevView, nextView,\r\n\t\t\tnode, tags, deep, tagName, tagCtx, validate, tagDepth, depth, fragment, copiedNode, firstTag, parentTag,\r\n\t\t\tisVoid, wrapper, div, tokens, elCnt, prevElCnt, htmlTag, ids, prevIds, found, skip, lazyLink, isLink, get,\r\n\t\t\tself = this,\r\n\t\t\tthisId = self._.id + \"_\",\r\n\t\t\tdefer = \"\",\r\n\t\t\t// The marker ids for which no tag was encountered (empty views or final closing markers) which we carry over to container tag\r\n\t\t\tbindEls = [],\r\n\t\t\ttagStack = [],\r\n\t\t\tdeferStack = [],\r\n\t\t\tonAfterCreate = self.hlp(onAfterCreateStr),\r\n\t\t\tprocessInfos = processViewInfos;\r\n\r\n\t\tif (refresh) {\r\n\t\t\tlazyLink = refresh.lazyLink && $.Deferred();\r\n\t\t\tif (refresh.tmpl) {\r\n\t\t\t\t// refresh is the prevView, passed in from addViews()\r\n\t\t\t\tprevView = \"/\" + refresh._.id + \"_\";\r\n\t\t\t} else {\r\n\t\t\t\tisLink = refresh.lnk; // Top-level linking\r\n\t\t\t\tif (refresh.tag) {\r\n\t\t\t\t\tthisId = refresh.tag + \"^\";\r\n\t\t\t\t\trefresh = true;\r\n\t\t\t\t}\r\n\t\t\t\tif (get = refresh.get) {\r\n\t\t\t\t\tprocessInfos = getViewInfos;\r\n\t\t\t\t\ttags = get.tags;\r\n\t\t\t\t\tdeep = get.deep;\r\n\t\t\t\t\ttagName = get.name;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\trefresh = refresh === true;\r\n\t\t}\r\n\r\n\t\tparentNode = parentNode\r\n\t\t\t? (\"\" + parentNode === parentNode\r\n\t\t\t\t? $(parentNode)[0]  // It is a string, so treat as selector\r\n\t\t\t\t: parentNode.jquery\r\n\t\t\t\t\t? parentNode[0] // A jQuery object - take first element.\r\n\t\t\t\t\t: parentNode)\r\n\t\t\t: (self.parentElem      // view.link()\r\n\t\t\t\t|| document.body);  // link(null, data) to link the whole document\r\n\r\n\t\tvalidate = !$viewsSettings.noValidate && parentNode.contentEditable !== TRUE;\r\n\t\tparentTag = parentNode.tagName.toLowerCase();\r\n\t\telCnt = !!elContent[parentTag];\r\n\r\n\t\tprevNode = prevNode && markPrevOrNextNode(prevNode, elCnt);\r\n\t\tnextNode = nextNode && markPrevOrNextNode(nextNode, elCnt) || null;\r\n\r\n\t\tif (html != undefined) {\r\n\t\t\t//================ Insert html into DOM using documentFragments (and wrapping HTML appropriately). ================\r\n\t\t\t// Also convert markers to DOM annotations, based on content model.\r\n\t\t\t// Corresponds to nextNode ? $(nextNode).before(html) : $(parentNode).html(html);\r\n\t\t\t// but allows insertion to wrap correctly even with inserted script nodes. jQuery version will fail e.g. under tbody or select.\r\n\t\t\t// This version should also be slightly faster\r\n\t\t\tdiv = document.createElement(\"div\");\r\n\t\t\twrapper = div;\r\n\t\t\tprevIds = ids = \"\";\r\n\t\t\thtmlTag = parentNode.namespaceURI === \"http://www.w3.org/2000/svg\" ? \"svg_ns\" : (firstTag = rFirstElem.exec(html)) && firstTag[1] || \"\";\r\n\t\t\tif (noDomLevel0 && firstTag && firstTag[2]) {\r\n\t\t\t\terror(\"Unsupported: \" + firstTag[2]); // For security reasons, don't allow insertion of elements with onFoo attributes.\r\n\t\t\t}\r\n\t\t\tif (elCnt) {\r\n\t\t\t\t// Now look for following view, and find its tokens, or if not found, get the parentNode._df tokens\r\n\t\t\t\tnode = nextNode;\r\n\t\t\t\twhile (node && !(nextView = viewInfos(node))) {\r\n\t\t\t\t\tnode = node.nextSibling;\r\n\t\t\t\t}\r\n\t\t\t\tif (tokens = nextView ? nextView._tkns : parentNode._df) {\r\n\t\t\t\t\ttoken = prevView || \"\";\r\n\t\t\t\t\tif (refresh || !prevView) {\r\n\t\t\t\t\t\ttoken += \"#\" + thisId;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tj = tokens.indexOf(token);\r\n\t\t\t\t\tif (j + 1) {\r\n\t\t\t\t\t\tj += token.length;\r\n\t\t\t\t\t\t// Transfer the initial tokens to inserted nodes, by setting them as the ids variable, picked up in convertMarkers\r\n\t\t\t\t\t\tprevIds = ids = tokens.slice(0, j);\r\n\t\t\t\t\t\ttokens = tokens.slice(j);\r\n\t\t\t\t\t\tif (nextView) {\r\n\t\t\t\t\t\t\tnode.setAttribute(jsvAttrStr, tokens);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tsetDefer(parentNode, tokens);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//================ Convert the markers to DOM annotations, based on content model. ================\r\n//\t\t\toldElCnt = elCnt;\r\n\t\t\tisVoid = undefined;\r\n\t\t\thtml = (\"\" + html).replace(rConvertMarkers, convertMarkers);\r\n//\t\t\tif (!!oldElCnt !== !!elCnt) {\r\n//\t\t\t\terror(\"Parse: \" + html); // Parse error. Content not well-formed?\r\n//\t\t\t}\r\n\t\t\tif (validate && tagStack.length) {\r\n\t\t\t\tsyntaxError(\"Mismatched '<\" + parentTag + \"...>' in:\\n\" + html); // Unmatched tag\r\n\t\t\t}\r\n\t\t\tif (validateOnly) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// Append wrapper element to doc fragment\r\n\t\t\tsafeFragment.appendChild(div);\r\n\r\n\t\t\t// Go to html and back, then peel off extra wrappers\r\n\t\t\t// Corresponds to jQuery $(nextNode).before(html) or $(parentNode).html(html);\r\n\t\t\t// but supports svg elements, and other features missing from jQuery version (and this version should also be slightly faster)\r\n\t\t\thtmlTag = wrapMap[htmlTag] || wrapMap.div;\r\n\t\t\tdepth = htmlTag[0];\r\n\t\t\twrapper.innerHTML = htmlTag[1] + html + htmlTag[2];\r\n\t\t\twhile (depth--) {\r\n\t\t\t\twrapper = wrapper.lastChild;\r\n\t\t\t}\r\n\t\t\tsafeFragment.removeChild(div);\r\n\t\t\tfragment = document.createDocumentFragment();\r\n\t\t\twhile (copiedNode = wrapper.firstChild) {\r\n\t\t\t\tfragment.appendChild(copiedNode);\r\n\t\t\t}\r\n\t\t\t// Insert into the DOM\r\n\t\t\tparentNode.insertBefore(fragment, nextNode);\r\n\t\t}\r\n\r\n\t\tif (lazyLink) {\r\n\t\t\tsetTimeout(dataLink, 0);\r\n\t\t} else {\r\n\t\t\tdataLink();\r\n\t\t}\r\n\r\n\t\treturn lazyLink && lazyLink.promise();\r\n\t}\r\n\r\n\tfunction addDataBinding(linkMarkup, node, currentView, boundTagId, isLink, data, context) {\r\n\t\t// Add data binding for data-linked elements or {^{...}} data-linked tags\r\n\t\tvar tmpl, tokens, attr, convertBack, params, trimLen, tagExpr, linkFn, linkCtx, tag, rTagIndex, hasElse,\r\n\t\t\tlinkExpressions = [];\r\n\r\n\t\tif (boundTagId) {\r\n\t\t\t// boundTagId is a string for {^{...}} data-linked tag. So only one linkTag in linkMarkup\r\n\t\t\t// data and context parameters are undefined\r\n\t\t\ttag = bindingStore[boundTagId];\r\n\t\t\ttag = tag.linkCtx ? tag.linkCtx.tag : tag;\r\n\r\n\t\t\tlinkCtx = tag.linkCtx || {\r\n\t\t\t\tdata: currentView.data,                   // source\r\n\t\t\t\telem: tag._elCnt ? tag.parentElem : node, // target\r\n\t\t\t\tview: currentView,\r\n\t\t\t\tctx: currentView.ctx,\r\n\t\t\t\tattr: HTML, // Script marker nodes are associated with {^{ and always target HTML.\r\n\t\t\t\tfn: tag._.bnd,\r\n\t\t\t\ttag: tag,\r\n\t\t\t\t// Pass the boundTagId in the linkCtx, so that it can be picked up in observeAndBind\r\n\t\t\t\t_bndId: boundTagId\r\n\t\t\t};\r\n\t\t\tbindDataLinkTarget(linkCtx, linkCtx.fn);\r\n\t\t} else if (linkMarkup && node) {\r\n\t\t\t// If isLink then this is a top-level linking: .link(expression, target, data, ....) or\r\n\t\t\t// .link(true, target, data, ....) scenario - and data and context are passed in separately from the view\r\n\t\t\tdata = isLink ? data : currentView.data;\r\n\r\n\t\t\t// Compiled linkFn expressions could be stored in the tmpl.links array of the template\r\n\t\t\t// TODO - consider also caching globally so that if {{:foo}} or data-link=\"foo\" occurs in different places,\r\n\t\t\t// the compiled template for this is cached and only compiled once...\r\n\t\t\t//links = currentView.links || currentView.tmpl.links;\r\n\r\n\t\t\ttmpl = currentView.tmpl;\r\n\r\n//\t\t\tif (!(linkTags = links[linkMarkup])) {\r\n\t\t\t// This is the first time this view template has been linked, so we compile the data-link expressions, and store them on the template.\r\n\r\n\t\t\tlinkMarkup = normalizeLinkTag(linkMarkup, defaultAttr(node));\r\n\t\t\trTagDatalink.lastIndex = 0;\r\n\r\n\t\t\twhile (tokens = rTagDatalink.exec(linkMarkup)) { // TODO require } to be followed by whitespace or $, and remove the \\}(!\\}) option.\r\n\t\t\t\tlinkExpressions.push(tokens);\r\n\t\t\t}\r\n\t\t\twhile (tokens = linkExpressions.shift()) {\r\n\t\t\t\t// Iterate over the data-link expressions, for different target attrs,\r\n\t\t\t\t// e.g. <input data-link=\"{:firstName:} title{>~description(firstName, lastName)}\"\r\n\t\t\t\t// tokens: [all, attr, bindOnly, tagExpr, tagName, converter, colon, html, comment, code, params]\r\n\t\t\t\trTagIndex = rTagDatalink.lastIndex;\r\n\t\t\t\tattr = tokens[1];\r\n\t\t\t\ttagExpr = tokens[3];\r\n\t\t\t\twhile (linkExpressions[0] && linkExpressions[0][4] === \"else\") { // If this is {someTag...} and is followed by linkExpression is an {else...} add to tagExpr\r\n\t\t\t\t\ttagExpr += \"}{\" + linkExpressions.shift()[3];\r\n\t\t\t\t\thasElse = true;\r\n\t\t\t\t}\r\n\t\t\t\tif (hasElse) { // If an {else} has been added, need also to add closing {{/someTag}}\r\n\t\t\t\t\ttagExpr += \"}{{/\" + tokens[4] + \"}\";\r\n\t\t\t\t}\r\n\t\t\t\tparams = tokens[10];\r\n\t\t\t\tconvertBack = undefined;\r\n\r\n\t\t\t\tlinkCtx = {\r\n\t\t\t\t\tdata: data, // source\r\n\t\t\t\t\telem: node, // target\r\n\t\t\t\t\tview: currentView,\r\n\t\t\t\t\tctx: context,\r\n\t\t\t\t\tattr: attr,\r\n\t\t\t\t\tisLk: isLink, // top-level linking?\r\n\t\t\t\t\t_toLk : 1, // Flag to data-link on initial data-link call rendering call\r\n\t\t\t\t\t_noUpd : tokens[2] // Flag for data-link=\"^{...}\" so on initial data-link call will bind, but not render)\r\n\t\t\t\t};\r\n\r\n\t\t\t\tif (tokens[6]) {\r\n\t\t\t\t\t// TODO include this in the original rTagDatalink regex\r\n\t\t\t\t\t// Only for {:} link\"\r\n\r\n\t\t\t\t\tif (!attr && (convertBack = /:([\\w$]*)$/.exec(params))) {\r\n\t\t\t\t\t\t// two-way binding\r\n\t\t\t\t\t\tconvertBack = convertBack[1];\r\n\t\t\t\t\t\tif (convertBack !== undefined) {\r\n\t\t\t\t\t\t\t// There is a convertBack function\r\n\t\t\t\t\t\t\ttrimLen = - convertBack.length - 1;\r\n\t\t\t\t\t\t\ttagExpr = tagExpr.slice(0, trimLen - 1) + delimCloseChar0; // Remove the convertBack string from expression.\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (convertBack === null) {\r\n\t\t\t\t\t\tconvertBack = undefined;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlinkCtx.convert = tokens[5] || \"\";\r\n\t\t\t\t}\r\n\t\t\t\t// Compile the linkFn expression which evaluates and binds a data-link expression\r\n\t\t\t\t// TODO - optimize for the case of simple data path with no conversion, helpers, etc.:\r\n\t\t\t\t//     i.e. data-link=\"a.b.c\". Avoid creating new instances of Function every time. Can use a default function for all of these...\r\n\r\n\t\t\t\tlinkCtx.expr = attr + tagExpr;\r\n\t\t\t\tlinkFn = tmpl.links[tagExpr];\r\n\t\t\t\tif (!linkFn) {\r\n\t\t\t\t\ttmpl.links[tagExpr] = linkFn = $sub.tmplFn(tagExpr, tmpl, true, convertBack, hasElse);\r\n\t\t\t\t}\r\n\t\t\t\tlinkCtx.fn = linkFn;\r\n\t\t\t\tif (!attr && convertBack !== undefined) {\r\n\t\t\t\t\t// Default target, so allow 2 way binding\r\n\t\t\t\t\tlinkCtx.convertBack = convertBack;\r\n\t\t\t\t}\r\n\t\t\t\tbindDataLinkTarget(linkCtx, linkFn);\r\n\t\t\t\t// We store rTagIndex in local scope, since this addDataBinding method can sometimes be called recursively,\r\n\t\t\t\t// and each is using the same rTagDatalink instance.\r\n\t\t\t\trTagDatalink.lastIndex = rTagIndex;\r\n\t\t\t}\r\n//\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction bindDataLinkTarget(linkCtx, linkFn) {\r\n\t\t// Add data link bindings for a link expression in data-link attribute markup\r\n\t\tfunction handler(ev, eventArgs) {\r\n\t\t\tpropertyChangeHandler.call(linkCtx, ev, eventArgs, linkFn);\r\n\t\t\t// If the link expression uses a custom tag, the propertyChangeHandler call will call renderTag, which will set tagCtx on linkCtx\r\n\t\t}\r\n\t\thandler.noArray = true;\r\n\t\tif (linkCtx.isLk) {\r\n\t\t\t// Top-level linking: .link(expressionOrTrue, data, context) - so we need to create a view for the linking, with the data and ctx\r\n\t\t\t// which may be different than the current context of the target. Treat the new view as child of topView.\r\n\t\t\tlinkCtx.view = new $sub.View(linkCtx.ctx, \"link\", topView, linkCtx.data, topView.tmpl, undefined, undefined, addBindingMarkers);\r\n\t\t}\r\n\t\tlinkCtx._ctxCb = getContextCb(linkCtx.view); // _ctxCb is for filtering/appending to dependency paths: function(path, object) { return [(object|path)*]}\r\n\t\tlinkCtx._hdl = handler;\r\n\t\thandler(true);\r\n\t}\r\n\r\n\t//=====================\r\n\t// Data-linking helpers\r\n\t//=====================\r\n\r\n\tfunction removeSubStr(str, substr) {\r\n\t\tvar k;\r\n\t\treturn str\r\n\t\t\t? (k = str.indexOf(substr),\r\n\t\t\t\t(k + 1\r\n\t\t\t\t\t? str.slice(0, k) + str.slice(k + substr.length)\r\n\t\t\t\t\t: str))\r\n\t\t\t: \"\";\r\n\t}\r\n\r\n\tfunction markerNodeInfo(node) {\r\n\t\treturn node &&\r\n\t\t\t(\"\" + node === node\r\n\t\t\t\t? node\r\n\t\t\t\t: node.tagName === SCRIPT\r\n\t\t\t\t\t? node.type.slice(3)\r\n\t\t\t\t\t: node.nodeType === 1 && node.getAttribute(jsvAttrStr) || \"\");\r\n\t}\r\n\r\n\tfunction viewInfos(node, isVal, rBinding) {\r\n\t\t// Test whether node is a script marker node, and if so, return metadata\r\n\t\tfunction getInfos(all, open, close, id, ch, elPath) {\r\n\t\t\tinfos.push({\r\n\t\t\t\telCnt: elCnt,\r\n\t\t\t\tid: id,\r\n\t\t\t\tch: ch,\r\n\t\t\t\topen: open,\r\n\t\t\t\tclose: close,\r\n\t\t\t\tpath: elPath,\r\n\t\t\t\ttoken: all\r\n\t\t\t});\r\n\t\t}\r\n\t\tvar elCnt, tokens,\r\n\t\t\tinfos = [];\r\n\t\tif (tokens = isVal ? node : markerNodeInfo(node)) {\r\n\t\t\telCnt = infos.elCnt = node.tagName !== SCRIPT;\r\n\t\t\telCnt = tokens.charAt(0) === \"@\" || elCnt;\r\n\t\t\tinfos._tkns = tokens;\r\n\t\t\t// rMarkerTokens = /(?:(#)|(\\/))(\\d+)([_^])([-+@\\d]+)?/g;\r\n\t\t\ttokens.replace(rBinding || rMarkerTokens, getInfos);\r\n\t\t\treturn infos;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction unmarkPrevOrNextNode(node, elCnt) {\r\n\t\tif (node) {\r\n\t\t\tif (node.type === \"jsv\") {\r\n\t\t\t\tnode.parentNode.removeChild(node);\r\n\t\t\t} else if (elCnt && node.getAttribute($viewsLinkAttr) === \"\") {\r\n\t\t\t\tnode.removeAttribute($viewsLinkAttr);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction markPrevOrNextNode(node, elCnt) {\r\n\t\tvar marker = node;\r\n\t\twhile (elCnt && marker && marker.nodeType !== 1) {\r\n\t\t\tmarker = marker.previousSibling;\r\n\t\t}\r\n\t\tif (marker) {\r\n\t\t\tif (marker.nodeType !== 1) {\r\n\t\t\t\t// For text nodes, we will add a script node before\r\n\t\t\t\tmarker = document.createElement(SCRIPT);\r\n\t\t\t\tmarker.type = \"jsv\";\r\n\t\t\t\tnode.parentNode.insertBefore(marker, node);\r\n\t\t\t} else if (!markerNodeInfo(marker) && !marker.getAttribute($viewsLinkAttr)) {\r\n\t\t\t\t// For element nodes, we will add a data-link attribute (unless there is already one)\r\n\t\t\t\t// so that this node gets included in the node linking process.\r\n\t\t\t\tmarker.setAttribute($viewsLinkAttr, \"\");\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn marker;\r\n\t}\r\n\r\n\tfunction normalizeLinkTag(linkMarkup, twoway) {\r\n\t\tlinkMarkup = $.trim(linkMarkup).replace(rEscapeQuotes, \"\\\\$&\");\r\n\t\treturn linkMarkup.slice(-1) !== delimCloseChar0\r\n\t\t// If simplified syntax is used: data-link=\"expression\", convert to data-link=\"{:expression}\",\r\n\t\t// or for inputs, data-link=\"{:expression:}\" for (default) two-way binding\r\n\t\t\t? linkMarkup = delimOpenChar1 + \":\" + linkMarkup + (twoway ? \":\" : \"\") + delimCloseChar0\r\n\t\t\t: linkMarkup;\r\n\t}\r\n\r\n\t//===========================\r\n\t// Methods for views and tags\r\n\t//===========================\r\n\r\n\tlinkMethods = {\r\n\t\tcontents: function(deep, select) {\r\n\t\t\t// For a view or a tag, return jQuery object with the content nodes,\r\n\t\t\tif (deep !== !!deep) {\r\n\t\t\t\t// deep not boolean, so this is getContents(selector)\r\n\t\t\t\tselect = deep;\r\n\t\t\t\tdeep = undefined;\r\n\t\t\t}\r\n\t\t\tvar filtered,\r\n\t\t\t\tnodes = $(this.nodes());\r\n\t\t\tif (nodes[0]) {\r\n\t\t\t\tfiltered = select ? nodes.filter(select) : nodes;\r\n\t\t\t\tnodes = deep && select ? filtered.add(nodes.find(select)) : filtered;\r\n\t\t\t}\r\n\t\t\treturn nodes;\r\n\t\t},\r\n\r\n\t\tnodes: function(withMarkers, prevNode, nextNode) {\r\n\t\t\t// For a view or a tag, return top-level nodes\r\n\t\t\t// Do not return any script marker nodes, unless withMarkers is true\r\n\t\t\t// Optionally limit range, by passing in prevNode or nextNode parameters\r\n\r\n\t\t\tvar node,\r\n\t\t\t\tself = this,\r\n\t\t\t\telCnt = self._elCnt,\r\n\t\t\t\tprevIsFirstNode = !prevNode && elCnt,\r\n\t\t\t\tnodes = [];\r\n\r\n\t\t\tprevNode = prevNode || self._prv;\r\n\t\t\tnextNode = nextNode || self._nxt;\r\n\r\n\t\t\tnode = prevIsFirstNode\r\n\t\t\t\t? (prevNode === self._nxt\r\n\t\t\t\t\t? self.parentElem.lastSibling\r\n\t\t\t\t\t: prevNode)\r\n\t\t\t\t: (self._.inline === false\r\n\t\t\t\t\t? prevNode || self.linkCtx.elem.firstChild\r\n\t\t\t\t\t: prevNode && prevNode.nextSibling);\r\n\r\n\t\t\twhile (node && (!nextNode || node !== nextNode)) {\r\n\t\t\t\tif (withMarkers || elCnt || node.tagName !== SCRIPT) {\r\n\t\t\t\t\t// All the top-level nodes in the view\r\n\t\t\t\t\t// (except script marker nodes, unless withMarkers = true)\r\n\t\t\t\t\t// (Note: If a script marker node, viewInfo.elCnt undefined)\r\n\t\t\t\t\tnodes.push(node);\r\n\t\t\t\t}\r\n\t\t\t\tnode = node.nextSibling;\r\n\t\t\t}\r\n\t\t\treturn nodes;\r\n\t\t},\r\n\r\n\t\tchildTags: function(deep, tagName) {\r\n\t\t\t// For a view or a tag, return child tags - at any depth, or as immediate children only.\r\n\t\t\tif (deep !== !!deep) {\r\n\t\t\t\t// deep not boolean, so this is childTags(tagName) - which looks for top-level tags of given tagName\r\n\t\t\t\ttagName = deep;\r\n\t\t\t\tdeep = undefined;\r\n\t\t\t}\r\n\r\n\t\t\tvar self = this,\r\n\t\t\t\tview = self.link ? self : self.tagCtx.view, // this may be a view or a tag. If a tag, get the view from tag.view.tagCtx\r\n\t\t\t\tprevNode = self._prv,\r\n\t\t\t\telCnt = self._elCnt,\r\n\t\t\t\ttags = [];\r\n\r\n\t\t\tview.link(\r\n\t\t\t\tundefined,\r\n\t\t\t\tself.parentElem,\r\n\t\t\t\telCnt ? prevNode && prevNode.previousSibling : prevNode,\r\n\t\t\t\tself._nxt,\r\n\t\t\t\tundefined,\r\n\t\t\t\t{get:{\r\n\t\t\t\t\ttags: tags,\r\n\t\t\t\t\tdeep: deep,\r\n\t\t\t\t\tname: tagName,\r\n\t\t\t\t\tid: self.link ? self._.id + \"_\" : self._tgId + \"^\"\r\n\t\t\t\t}}\r\n\t\t\t);\r\n\t\t\treturn tags;\r\n\t\t},\r\n\r\n\t\trefresh: function(sourceValue) {\r\n\t\t\tvar promise, attr,\r\n\t\t\t\ttag = this,\r\n\t\t\t\tlinkCtx = tag.linkCtx,\r\n\t\t\t\tview = tag.tagCtx.view;\r\n\r\n\t\t\tif (tag.disposed) { error(\"Removed tag\"); }\r\n\t\t\tif (sourceValue === undefined) {\r\n\t\t\t\tsourceValue = $views._tag(tag, view, view.tmpl, mergeCtxs(tag), true); // Get rendered HTML for tag, based on refreshed tagCtxs\r\n\t\t\t}\r\n\t\t\tif (sourceValue + \"\" === sourceValue) {\r\n\t\t\t\t// If no rendered content, sourceValue will not be a string (can be 0 or undefined)\r\n\t\t\t\tattr = tag._.inline ? HTML : (linkCtx.attr || defaultAttr(tag.parentElem, true));\r\n\t\t\t\tpromise = updateContent(sourceValue, linkCtx, attr, tag);\r\n\t\t\t}\r\n\r\n\t\t\tcallAfterLink(tag);\r\n\t\t\treturn promise || tag;\r\n\t\t},\r\n\r\n\t\tupdate: function(value) {\r\n\t\t\tvar linkedElem = this.linkedElem;\r\n\t\t\tif (linkedElem) {\r\n\t\t\t\telemChangeHandler({\r\n\t\t\t\t\ttarget: linkedElem[0]\r\n\t\t\t\t}, undefined, value);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tfunction callAfterLink(tag, eventArgs) {\r\n\t\tvar $linkedElem, linkedElem, radioButtons, val, l, linkedTag, oldTrig, newTrig,\r\n\t\t\ttagCtx = tag.tagCtx,\r\n\t\t\tview = tagCtx.view,\r\n\t\t\tprops = tagCtx.props,\r\n\t\t\tlinkCtx = tag.linkCtx = tag.linkCtx || {\r\n\t\t\t\ttag: tag,\r\n\t\t\t\tdata: view.data,\r\n\t\t\t\tview: view,\r\n\t\t\t\tctx: view.ctx\r\n\t\t\t};\r\n\r\n\t\tif (tag.onAfterLink) {\r\n\t\t\ttag.onAfterLink(tagCtx, linkCtx, eventArgs);\r\n\t\t}\r\n\t\ttag._.unlinked = undefined;\r\n\t\t$linkedElem = tag.targetTag ? tag.targetTag.linkedElem : tag.linkedElem;\r\n\t\tif (!tag.noVal && (linkedElem = $linkedElem && $linkedElem[0])) {\r\n\t\t\tif (radioButtons = tag._.radio) {\r\n\t\t\t\t$linkedElem = $linkedElem.children(\"input[type=radio]\");\r\n\t\t\t}\r\n\t\t\tif (radioButtons || !tag._.chging) {\r\n\t\t\t\tval = tag.cvtArgs()[0];\r\n\r\n\t\t\t\tif (radioButtons || linkedElem !== linkCtx.elem) {\r\n\t\t\t\t\tl = $linkedElem.length;\r\n\t\t\t\t\twhile (l--) {\r\n\t\t\t\t\t\tlinkedElem = $linkedElem[l];\r\n\t\t\t\t\t\tlinkedTag = linkedElem._jsvLkEl;\r\n\t\t\t\t\t\tif (tag._.inline && (!linkedTag || linkedTag !== tag && linkedTag.targetTag !== tag)) {\r\n\t\t\t\t\t\t\t// For data-linked tags, identify the linkedElem with the tag, for \"to\" binding\r\n\t\t\t\t\t\t\t// (For data-linked elements, if not yet bound, we identify later when the linkCtx.elem is bound)\r\n\t\t\t\t\t\t\tlinkedElem._jsvLkEl = tag;\r\n\t\t\t\t\t\t\tbindTo(bindingStore[tag._tgId], tag.convertBack);\r\n\t\t\t\t\t\t\tlinkedElem._jsvBnd = \"&\" + tag._tgId + \"+\"; // Add a \"+\" for cloned binding - so removing\r\n\t\t\t\t\t\t\t// elems with cloned bindings will not remove the 'parent' binding from the bindingStore.\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (radioButtons) {\r\n\t\t\t\t\t\t\t// For radio button, set to if val === value. For others set val() to val, below\r\n\t\t\t\t\t\t\tlinkedElem[CHECKED] = val === linkedElem.value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlinkCtx._val = val;\r\n\t\t\t\t}\r\n\t\t\t\tif (val !== undefined) {\r\n\t\t\t\t\tif (!radioButtons && linkedElem.value !== undefined) {\r\n\t\t\t\t\t\tif (linkedElem.type === CHECKBOX) {\r\n\t\t\t\t\t\t\tlinkedElem[CHECKED] = val && val !== \"false\";\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t$linkedElem.val(val);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (linkedElem.contentEditable === TRUE) {\r\n\t\t\t\t\t\tlinkedElem.innerHTML = val;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (tag.setSize) {\r\n\t\t\t\tif (props.height) {\r\n\t\t\t\t\t$linkedElem.height(props.height);\r\n\t\t\t\t}\r\n\t\t\t\tif (props.width) {\r\n\t\t\t\t\t$linkedElem.width(props.width);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (props[\"class\"]) {\r\n\t\t\t\t$linkedElem.addClass(props[\"class\"]);\r\n\t\t\t}\r\n\t\t\tif (props.id) {\r\n\t\t\t\t$linkedElem[0].id = props.id;\r\n\t\t\t}\r\n\t\t\tif (props.name) {\r\n\t\t\t\t$linkedElem.attr(\"name\", props.name);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (linkedElem = linkedElem || tag.tagName === \":\" && linkCtx.elem) {\r\n\t\t\toldTrig = linkedElem._jsvTr;\r\n\t\t\tnewTrig = props.trigger;\r\n\t\t\tif (oldTrig !== newTrig) {\r\n\t\t\t\tlinkedElem._jsvTr = newTrig;\r\n\t\t\t\t$linkedElem = $linkedElem || $(linkedElem);\r\n\t\t\t\tbindElChange($linkedElem, oldTrig, \"off\");\r\n\t\t\t\tbindElChange($linkedElem, newTrig, \"on\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction asyncElemChangeHandler(ev) {\r\n\t\tsetTimeout(function() {\r\n\t\t\telemChangeHandler(ev);\r\n\t\t}, 0);\r\n\t}\r\n\r\n\tfunction bindElChange($elem, trig, onoff) {\r\n\t\tif (trig) {\r\n\t\t\t$elem[onoff](trig === true ? \"keydown\" : trig, trig === true ? asyncElemChangeHandler : elemChangeHandler);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction bindTo(binding, cvtBk) {\r\n\t\t// Two-way binding.\r\n\t\t// We set the binding.to[1] to be the cvtBack, and binding.to[0] to be either the path to the target, or [object, path] where the target is the path on the provided object.\r\n\t\t// So for a computed path with an object call: a.b.getObject().d.e, then we set to[0] to be [exprOb, \"d.e\"], and we bind to the path on the returned object, exprOb.ob, as target\r\n\t\t// Otherwise our target is the first path, paths[0], which we will convert with contextCb() for paths like ~a.b.c or #x.y.z\r\n\r\n\t\tvar bindto, pathIndex, path, lastPath, bindtoOb,\r\n\t\t\tlinkCtx = binding.linkCtx,\r\n\t\t\tsource = linkCtx.data,\r\n\t\t\tpaths = linkCtx.fn.paths;\r\n\t\tif (binding && paths) {\r\n\t\t\tpaths = (bindto = paths._jsvto) || paths[0];\r\n\t\t\tpathIndex = paths && paths.length;\r\n\t\t\tif (pathIndex && (!linkCtx.tag || linkCtx.tag.tagCtx.args.length)) {\r\n\t\t\t\tlastPath = paths[pathIndex - 1];\r\n\t\t\t\tif (lastPath._jsv) {\r\n\t\t\t\t\tbindtoOb = lastPath;\r\n\t\t\t\t\twhile (lastPath.sb && lastPath.sb._jsv) {\r\n\t\t\t\t\t\tpath = lastPath = lastPath.sb;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpath = lastPath.sb || path && path.path;\r\n\t\t\t\t\tlastPath = path ? path.slice(1) : bindtoOb.path;\r\n\t\t\t\t}\r\n\t\t\t\tbinding.to = path\r\n\t\t\t\t\t? [ // \"...someexpr().lastpath...\" - so need to get the bindtoOb 'exprOb' object for this view-binding\r\n\t\t\t\t\t\t[\r\n\t\t\t\t\t\t\tbindtoOb, // 'exprOb' for this expression and view-binding. So bindtoOb.ob is current object returned by expression.\r\n\t\t\t\t\t\t\tlastPath\r\n\t\t\t\t\t\t],\r\n\t\t\t\t\t\tcvtBk\r\n\t\t\t\t\t]\r\n\t\t\t\t\t: [\r\n\t\t\t\t\t\tlinkCtx._ctxCb(path = lastPath.split(\"^\").join(\".\")) || [source, path],\r\n\t\t\t\t\t\tcvtBk\r\n\t\t\t\t\t];\r\n\t\t\t} else {\r\n\t\t\t\tbinding.to = [[], cvtBk];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction mergeCtxs(tag, newCtxs, replace) { // Merge updated tagCtxs into tag.tagCtxs\r\n\t\tvar tagCtx, newTagCtx,\r\n\t\t\tview = tag.tagCtx.view,\r\n\t\t\ttagCtxs = tag.tagCtxs || [tag.tagCtx],\r\n\t\t\tl = tagCtxs.length,\r\n\t\t\trefresh = !newCtxs;\r\n\r\n\t\tnewCtxs = newCtxs || tag._.bnd.call(view.tmpl, (tag.linkCtx || view).data, view, $views);\r\n\r\n\t\tif (replace) {\r\n\t\t\t// Replace previous tagCtxs by new ones, rather than merging\r\n\t\t\ttagCtxs = tag.tagCtxs = newCtxs;\r\n\t\t\ttag.tagCtx = tagCtxs[0];\r\n\t\t} else {\r\n\t\t\twhile (l--) {\r\n\t\t\t\ttagCtx = tagCtxs[l];\r\n\t\t\t\tnewTagCtx = newCtxs[l];\r\n\t\t\t\t$observable(tagCtx.props).setProperty(newTagCtx.props);\r\n\t\t\t\t$extend(tagCtx.ctx, newTagCtx.ctx); // We don't support propagating ctx variables, ~foo, observably, to nested views. So extend, not setProperty...\r\n\t\t\t\ttagCtx.args = newTagCtx.args;\r\n\t\t\t\tif (refresh) {\r\n\t\t\t\t\ttagCtx.tmpl = newTagCtx.tmpl;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t$sub._ths(tag, tagCtxs[0]); // tagHandlersFromProps\r\n\t\treturn tagCtxs;\r\n\t}\r\n\r\n\t//=========\r\n\t// Disposal\r\n\t//=========\r\n\r\n\tfunction clean(elems) {\r\n\t\t// Remove data-link bindings, or contained views\r\n\t\tvar l, elem, bindings,\r\n\t\t\telemArray = [],\r\n\t\t\tlen = elems.length,\r\n\t\t\ti = len;\r\n\t\twhile (i--) {\r\n\t\t\t// Copy into an array, so that deletion of nodes from DOM will not cause our 'i' counter to get shifted\r\n\t\t\t// (Note: This seems as fast or faster than elemArray = [].slice.call(elems); ...)\r\n\t\t\telemArray.push(elems[i]);\r\n\t\t}\r\n\t\ti = len;\r\n\t\twhile (i--) {\r\n\t\t\telem = elemArray[i];\r\n\t\t\tif (elem.parentNode) {\r\n\t\t\t\t// Has not already been removed from the DOM\r\n\t\t\t\tif (bindings = elem._jsvBnd) {\r\n\t\t\t\t\t// Get propertyChange bindings for this element\r\n\t\t\t\t\t// This may be an element with data-link, or the opening script marker node for a data-linked tag {^{...}}\r\n\t\t\t\t\t// bindings is a string with the syntax: \"(&bindingId)*\"\r\n\t\t\t\t\tbindings = bindings.slice(1).split(\"&\");\r\n\t\t\t\t\telem._jsvBnd = \"\";\r\n\t\t\t\t\tl = bindings.length;\r\n\t\t\t\t\twhile (l--) {\r\n\t\t\t\t\t\t// Remove associated bindings\r\n\t\t\t\t\t\tremoveViewBinding(bindings[l], elem._jsvLkEl, elem); // unbind bindings with this bindingId on this view\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tdisposeTokens(markerNodeInfo(elem) + (elem._df || \"\"));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction removeViewBinding(bindId, linkedElemTag, elem) {\r\n\t\t// Unbind\r\n\t\tvar objId, linkCtx, tag, object, obsId, tagCtxs, l, map, $linkedElem, linkedElem, trigger,\r\n\t\t\tbinding = bindingStore[bindId];\r\n\r\n\t\tif (linkedElemTag) {\r\n\t\t\tif (elem === linkedElemTag.linkedElem[0]) {\r\n\t\t\t\telem._jsvLkEl = undefined;\r\n\t\t\t\tlinkedElemTag.linkedElem = undefined;\r\n\t\t\t}\r\n\t\t} else if (binding) {\r\n\t\t\tdelete bindingStore[bindId]; // Delete already, so call to onDispose handler below cannot trigger recursive deletion (through recursive call to jQuery cleanData)\r\n\t\t\tfor (objId in binding.bnd) {\r\n\t\t\t\tobject = binding.bnd[objId];\r\n\t\t\t\tobsId = binding.cbId;\r\n\t\t\t\tif ($.isArray(object)) {\r\n\t\t\t\t\t$([object]).off(arrayChangeStr + obsId).off(propertyChangeStr + obsId); // There may be either or both of arrayChange and propertyChange\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$(object).off(propertyChangeStr + obsId);\r\n\t\t\t\t}\r\n\t\t\t\tdelete binding.bnd[objId];\r\n\t\t\t}\r\n\r\n\t\t\tif (linkCtx = binding.linkCtx) {\r\n\t\t\t\tif (tag = linkCtx.tag) {\r\n\t\t\t\t\tif (tagCtxs = tag.tagCtxs) {\r\n\t\t\t\t\t\tl = tagCtxs.length;\r\n\t\t\t\t\t\twhile (l--) {\r\n\t\t\t\t\t\t\tif (map = tagCtxs[l].map) {\r\n\t\t\t\t\t\t\t\tmap.unmap(); //unobserve\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$linkedElem = tag.linkedElem;\r\n\t\t\t\t\tlinkedElem = $linkedElem && $linkedElem[0] || linkCtx.elem;\r\n\r\n\t\t\t\t\tif (trigger = linkedElem && linkedElem._jsvTr) {\r\n\t\t\t\t\t\tbindElChange($linkedElem || $(linkedElem), trigger, \"off\");\r\n\t\t\t\t\t\tlinkedElem._jsvTr = undefined;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (tag.onDispose) {\r\n\t\t\t\t\t\ttag.onDispose();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (!tag._elCnt) {\r\n\t\t\t\t\t\tif (tag._prv) {\r\n\t\t\t\t\t\t\ttag._prv.parentNode.removeChild(tag._prv);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (tag._nxt) {\r\n\t\t\t\t\t\t\ttag._nxt.parentNode.removeChild(tag._nxt);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tdelete linkCtx.view._.bnds[bindId];\r\n\t\t\t}\r\n\t\t\t$sub._cbBnds[binding.cbId] = undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction $unlink(tmplOrLinkTag, to) {\r\n\t\tif (tmplOrLinkTag === undefined) {\r\n\t\t\t// Call to $.unlink() is equivalent to $.unlink(true, \"body\")\r\n\t\t\tif (activeBody) {\r\n\t\t\t\t$(activeBody)\r\n\t\t\t\t\t.off(elementChangeStr, elemChangeHandler)\r\n\t\t\t\t\t.off('blur', '[contenteditable]', elemChangeHandler);\r\n\t\t\t\tactiveBody = undefined;\r\n\t\t\t}\r\n\t\t\ttmplOrLinkTag = true;\r\n\t\t\ttopView.removeViews();\r\n\t\t\tclean(document.body.getElementsByTagName(\"*\"));\r\n\t\t} else if (to && tmplOrLinkTag === true) {\r\n\t\t\tto = to.jquery ? to : $(to); // to is a jquery object or an element or selector\r\n\t\t\tto.each(function() {\r\n\t\t\t\tvar innerView;\r\n\t\t\t\twhile ((innerView = $view(this, true)) && innerView.parent) {\r\n\t\t\t\t\tinnerView.parent.removeViews(innerView._.key, undefined, true);\r\n\t\t\t\t}\r\n\t\t\t\tclean(this.getElementsByTagName(\"*\"));\r\n\t\t\t\tclean([this]);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn to; // Allow chaining, to attach event handlers, etc.\r\n\r\n//} else if (to) {\r\n//\tto = to.jquery ? to : $(to); // to is a jquery object or an element or selector\r\n//\tif (tmplOrLinkTag === true) {\r\n//\t\t// Call to $(el).unlink(true) - unlink content of element, but don't remove bindings on element itself\r\n//\t\tto.each(function() {\r\n//\t\t\tvar innerView;\r\n////TODO fix this for better perf. Rather that calling inner view multiple times which does querySelectorAll each time, consider a single querySelectorAll\r\n//// or simply call view.removeViews() on the top-level views under the target 'to' node, then clean(...)\r\n//\t\t\twhile ((innerView = $view(this, true)) && innerView.parent) {\r\n//\t\t\t\tinnerView.parent.removeViews(innerView._.key, undefined, true);\r\n//\t\t\t}\r\n//\t\t\tclean(this.getElementsByTagName(\"*\"));\r\n//\t\t\tclean([this]);\r\n//\t\t});\r\n//\t} else if (tmplOrLinkTag === undefined) {\r\n//\t\t// Call to $(el).unlink() // Not currently supported\r\n//\t\tclean(to);\r\n////TODO provide this unlink API\r\n//\t} else if (\"\" + tmplOrLinkTag === tmplOrLinkTag) {\r\n//\t\t// Call to $(el).unlink(tmplOrLinkTag ...)\r\n//\t\t$.each(to, function() {\r\n//\t\t\t//...\r\n//\t\t});\r\n//\t}\r\n//TODO - unlink the content and the arrayChange, but not any other bindings on the element (if container rather than \"replace\")\r\n\t}\r\n\r\n\tfunction tmplUnlink(to, from) {\r\n\t\treturn $unlink(this, to, from);\r\n\t}\r\n\r\n\t//========\r\n\t// Helpers\r\n\t//========\r\n\r\n\tfunction getContextCb(view) {\r\n\t\t// TODO Consider exposing or allowing override, as public API\r\n\t\treturn function(path, object) {\r\n\t\t\t// TODO consider only calling the contextCb on the initial token in path '~a.b.c' and not calling again on\r\n\t\t\t// the individual tokens, 'a', 'b', 'c'... Currently it is called multiple times\r\n\t\t\tvar tokens, tag,\r\n\t\t\t\titems = [object];\r\n\t\t\tif (view && path) {\r\n\t\t\t\tif (path._jsv) {\r\n\t\t\t\t\treturn path._jsv.call(view.tmpl, object, view, $views);\r\n\t\t\t\t}\r\n\t\t\t\tif (path.charAt(0) === \"~\") {\r\n\t\t\t\t\t// We return new items to insert into the sequence, replacing the \"~a.b.c\" string:\r\n\t\t\t\t\t// [helperObject 'a', \"a.b.c\" currentDataItem] so currentDataItem becomes the object for subsequent paths.\r\n\t\t\t\t\tif (path.slice(0, 4) === \"~tag\") {\r\n\t\t\t\t\t\ttag = view.ctx;\r\n\t\t\t\t\t\tif (path.charAt(4) === \".\") {\r\n\t\t\t\t\t\t\t// \"~tag.xxx\"\r\n\t\t\t\t\t\t\ttokens = path.slice(5).split(\".\");\r\n\t\t\t\t\t\t\ttag = tag.tag;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (tokens) {\r\n\t\t\t\t\t\t\treturn tag ? [tag, tokens.join(\".\"), object] : [];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpath = path.slice(1).split(\".\");\r\n\t\t\t\t\tif (object = view.hlp(path.shift())) {\r\n\t\t\t\t\t\tif (path.length) {\r\n\t\t\t\t\t\t\titems.unshift(path.join(\".\"));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\titems.unshift(object);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn object ? items : [];\r\n\t\t\t\t}\r\n\t\t\t\tif (path.charAt(0) === \"#\") {\r\n\t\t\t\t\t// We return new items to insert into the sequence, replacing the \"#a.b.c\" string: [view, \"a.b.c\" currentDataItem]\r\n\t\t\t\t\t// so currentDataItem becomes the object for subsequent paths. The 'true' flag makes the paths bind only to leaf changes.\r\n\t\t\t\t\treturn path === \"#data\" ? [] : [view, path.replace(rViewPath, \"\"), object];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\tfunction inputAttrib(elem) {\r\n\t\treturn elem.type === CHECKBOX ? elem[CHECKED] : elem.value;\r\n\t}\r\n\r\n\t//========================== Initialize ==========================\r\n\r\n\t//=====================\r\n\t// JsRender integration\r\n\t//=====================\r\n\r\n\t$sub.onStore.template = function(name, item) {\r\n\t\titem.link = tmplLink;\r\n\t\titem.unlink = tmplUnlink;\r\n\t\tif (name) {\r\n\t\t\t$.link[name] = function() {\r\n\t\t\t\treturn tmplLink.apply(item, arguments);\r\n\t\t\t};\r\n\t\t\t$.unlink[name] = function() {\r\n\t\t\t\treturn tmplUnlink.apply(item, arguments);\r\n\t\t\t};\r\n\t\t}\r\n\t};\r\n\r\n\t$extend($extend($sub._tg.prototype, linkMethods), {  // Add linkMethods to tagDef prototype\r\n\t\tdomChange: function() { // domChange notification support\r\n\t\t\tvar elem = this.parentElem,\r\n\t\t\t\thasListener = $.hasData(elem) && $._data(elem).events,\r\n\t\t\t\tdomChangeNotification = \"jsv-domchange\";\r\n\r\n\t\t\tif (hasListener && hasListener[domChangeNotification]) {\r\n\t\t\t\t// Only trigger handler if there is a handler listening for this event. (Note using triggerHandler - so no event bubbling.)\r\n\t\t\t\t$(elem).triggerHandler(domChangeNotification, arguments);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\t$sub.viewInfos = viewInfos; // Expose viewInfos() as public helper method\r\n\r\n\t// Initialize default delimiters\r\n\t($viewsSettings.delimiters = function() {\r\n\t\tvar delimChars = oldJsvDelimiters.apply(0, arguments);\r\n\t\tdelimOpenChar0 = delimChars[0];\r\n\t\tdelimOpenChar1 = delimChars[1];\r\n\t\tdelimCloseChar0 = delimChars[2];\r\n\t\tdelimCloseChar1 = delimChars[3];\r\n\t\tlinkChar = delimChars[4];\r\n\t\trTagDatalink = new RegExp(\"(?:^|\\\\s*)([\\\\w-]*)(\\\\\" + linkChar + \")?(\\\\\" + delimOpenChar1 + $sub.rTag + \"\\\\\" + delimCloseChar0 + \")\", \"g\");\r\n\r\n\t\t// Default rTag:      attr  bind tagExpr   tag         converter colon html     comment            code      params\r\n\t\t//          (?:^|\\s*)([\\w-]*)(\\^)?({(?:(?:(\\w+(?=[\\/\\s}]))|(?:(\\w+)?(:)|(>)|!--((?:[^-]|-(?!-))*)--|(\\*)))\\s*((?:[^}]|}(?!}))*?))})\r\n\t\treturn this;\r\n\t})(); // jshint ignore:line\r\n\r\n\t//====================================\r\n\t// Additional members for linked views\r\n\t//====================================\r\n\r\n\tfunction transferViewTokens(prevNode, nextNode, parentElem, id, viewOrTagChar, refresh) {\r\n\t\t// Transfer tokens on prevNode of viewToRemove/viewToRefresh to nextNode or parentElem._df\r\n\t\tvar i, l, vwInfos, vwInfo, viewOrTag, viewId, tokens,\r\n\t\t\tprecedingLength = 0,\r\n\t\t\temptyView = prevNode === nextNode;\r\n\r\n\t\tif (prevNode) {\r\n\t\t\t// prevNode is either the first node in the viewOrTag, or has been replaced by the vwInfos tokens string\r\n\t\t\tvwInfos = viewInfos(prevNode) || [];\r\n\t\t\tfor (i = 0, l = vwInfos.length; i < l; i++) {\r\n\t\t\t\t// Step through views or tags on the prevNode\r\n\t\t\t\tvwInfo = vwInfos[i];\r\n\t\t\t\tviewId = vwInfo.id;\r\n\t\t\t\tif (viewId === id && vwInfo.ch === viewOrTagChar) {\r\n\t\t\t\t\tif (refresh) {\r\n\t\t\t\t\t\t// This is viewOrTagToRefresh, this is the last viewOrTag to process...\r\n\t\t\t\t\t\tl = 0;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// This is viewOrTagToRemove, so we are done...\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (!emptyView) {\r\n\t\t\t\t\tviewOrTag = vwInfo.ch === \"_\"\r\n\t\t\t\t\t\t? viewStore[viewId]\r\n\t\t\t\t\t\t: bindingStore[viewId].linkCtx.tag;\r\n\t\t\t\t\tif (vwInfo.open) {\r\n\t\t\t\t\t\t// A \"#m\" token\r\n\t\t\t\t\t\tviewOrTag._prv = nextNode;\r\n\t\t\t\t\t} else if (vwInfo.close) {\r\n\t\t\t\t\t\t// A \"/m\" token\r\n\t\t\t\t\t\tviewOrTag._nxt = nextNode;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tprecedingLength += viewId.length + 2;\r\n\t\t\t}\r\n\r\n\t\t\tif (precedingLength) {\r\n\t\t\t\tprevNode.setAttribute(jsvAttrStr, prevNode.getAttribute(jsvAttrStr).slice(precedingLength));\r\n\t\t\t}\r\n\t\t\ttokens = nextNode ? nextNode.getAttribute(jsvAttrStr) : parentElem._df;\r\n\t\t\tif (l = tokens.indexOf(\"/\" + id + viewOrTagChar) + 1) {\r\n\t\t\t\ttokens = vwInfos._tkns.slice(0, precedingLength) + tokens.slice(l + (refresh ? -1 : id.length + 1));\r\n\t\t\t}\r\n\t\t\tif (tokens) {\r\n\t\t\t\tif (nextNode) {\r\n\t\t\t\t\t// If viewOrTagToRemove was an empty viewOrTag, we will remove both #n and /n\r\n\t\t\t\t\t// (and any intervening tokens) from the nextNode (=== prevNode)\r\n\t\t\t\t\t// If viewOrTagToRemove was not empty, we will take tokens preceding #n from prevNode,\r\n\t\t\t\t\t// and concatenate with tokens following /n on nextNode\r\n\t\t\t\t\tnextNode.setAttribute(jsvAttrStr, tokens);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsetDefer(parentElem, tokens);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// !prevNode, so there may be a deferred nodes token on the parentElem. Remove it.\r\n\t\t\tsetDefer(parentElem, removeSubStr(parentElem._df, \"#\" + id + viewOrTagChar));\r\n\t\t\tif (!refresh && !nextNode) {\r\n\t\t\t\t// If this viewOrTag is being removed, and there was no .nxt, remove closing token from deferred tokens\r\n\t\t\t\tsetDefer(parentElem, removeSubStr(parentElem._df, \"/\" + id + viewOrTagChar));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction disposeTokens(tokens) {\r\n\t\tvar i, l, vwItem, vwInfos;\r\n\t\tif (vwInfos = viewInfos(tokens, true, rOpenMarkers)) {\r\n\t\t\tfor (i = 0, l = vwInfos.length; i < l; i++) {\r\n\t\t\t\tvwItem = vwInfos[i];\r\n\t\t\t\tif (vwItem.ch === \"_\") {\r\n\t\t\t\t\tif ((vwItem = viewStore[vwItem.id]) && vwItem.type) {\r\n\t\t\t\t\t\t// If this is the _prv (prevNode) for a view, remove the view\r\n\t\t\t\t\t\t// - unless view.type is undefined, in which case it is already being removed\r\n\t\t\t\t\t\tvwItem.parent.removeViews(vwItem._.key, undefined, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tremoveViewBinding(vwItem.id); // unbind bindings with this bindingId on this view\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//====================================\r\n\t// Add linked view methods to view prototype\r\n\t//====================================\r\n\r\n\t$extend(\r\n\t\t$extend($sub.View.prototype, linkMethods), {\r\n\t\t\t// Note: a linked view will also, after linking have nodes[], _prv (prevNode), _nxt (nextNode) ...\r\n\t\t\taddViews: function(index, dataItems, tmpl) {\r\n\t\t\t\t// if view is not an array view, do nothing\r\n\t\t\t\tvar i, viewsCount,\r\n\t\t\t\t\tself = this,\r\n\t\t\t\t\titemsCount = dataItems.length,\r\n\t\t\t\t\tviews = self.views;\r\n\r\n\t\t\t\tif (!self._.useKey && itemsCount && (tmpl = self.tmpl)) {\r\n\t\t\t\t\t// view is of type \"array\"\r\n\t\t\t\t\t// Use passed-in template if provided, since self added view may use a different template than the original one used to render the array.\r\n\t\t\t\t\tviewsCount = views.length + itemsCount;\r\n\r\n\t\t\t\t\tif (viewsCount === self.data.length // If views not already synced to array (e.g. triggered by array.length propertyChange - jsviews/issues/301)\r\n\t\t\t\t\t\t && renderAndLink(self, index, tmpl, views, dataItems, self.ctx) !== false) {\r\n\t\t\t\t\t\tfor (i = index + itemsCount; i < viewsCount; i++) {\r\n\t\t\t\t\t\t\t$observable(views[i]).setProperty(\"index\", i);\r\n\t\t\t\t\t\t\t// This is fixing up index, but not key, and not index on child views. From child views, use view.getIndex()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn self;\r\n\t\t\t},\r\n\r\n\t\t\tremoveViews: function(index, itemsCount, keepNodes) {\r\n\t\t\t\t// view.removeViews() removes all the child views\r\n\t\t\t\t// view.removeViews(index) removes the child view with specified index or key\r\n\t\t\t\t// view.removeViews(index, count) removes the specified nummber of child views, starting with the specified index\r\n\t\t\t\tfunction removeView(index) {\r\n\t\t\t\t\tvar id, bindId, parentElem, prevNode, nextNode, nodesToRemove,\r\n\t\t\t\t\t\tviewToRemove = views[index];\r\n\r\n\t\t\t\t\tif (viewToRemove && viewToRemove.link) {\r\n\t\t\t\t\t\tid = viewToRemove._.id;\r\n\t\t\t\t\t\tif (!keepNodes) {\r\n\t\t\t\t\t\t\t// Remove the HTML nodes from the DOM, unless they have already been removed, including nodes of child views\r\n\t\t\t\t\t\t\tnodesToRemove = viewToRemove.nodes();\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Remove child views, without removing nodes\r\n\t\t\t\t\t\tviewToRemove.removeViews(undefined, undefined, true);\r\n\r\n\t\t\t\t\t\tviewToRemove.type = undefined; // Set type to undefined: used as a flag that this view is being removed\r\n\t\t\t\t\t\tprevNode = viewToRemove._prv;\r\n\t\t\t\t\t\tnextNode = viewToRemove._nxt;\r\n\t\t\t\t\t\tparentElem = viewToRemove.parentElem;\r\n\t\t\t\t\t\t// If prevNode and nextNode are the same, the view is empty\r\n\t\t\t\t\t\tif (!keepNodes) {\r\n\t\t\t\t\t\t\t// Remove the HTML nodes from the DOM, unless they have already been removed, including nodes of child views\r\n\t\t\t\t\t\t\tif (viewToRemove._elCnt) {\r\n\t\t\t\t\t\t\t\t// if keepNodes is false (and transferring of tokens has not already been done at a higher level)\r\n\t\t\t\t\t\t\t\t// then transfer tokens from prevNode which is being removed, to nextNode.\r\n\t\t\t\t\t\t\t\ttransferViewTokens(prevNode, nextNode, parentElem, id, \"_\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t$(nodesToRemove).remove();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!viewToRemove._elCnt) {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tprevNode.parentNode.removeChild(prevNode); // (prevNode.parentNode is parentElem, except if jQuery Mobile or similar has inserted an intermediate wrapper\r\n\t\t\t\t\t\t\t\tnextNode.parentNode.removeChild(nextNode);\r\n\t\t\t\t\t\t\t} catch (e) {}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsetArrayChangeLink(viewToRemove);\r\n\t\t\t\t\t\tfor (bindId in viewToRemove._.bnds) {\r\n\t\t\t\t\t\t\tremoveViewBinding(bindId);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdelete viewStore[id];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar current, view, viewsCount,\r\n\t\t\t\t\tself = this,\r\n\t\t\t\t\tisArray = !self._.useKey,\r\n\t\t\t\t\tviews = self.views;\r\n\r\n\t\t\t\tif (isArray) {\r\n\t\t\t\t\tviewsCount = views.length;\r\n\t\t\t\t}\r\n\t\t\t\tif (index === undefined) {\r\n\t\t\t\t\t// Remove all child views\r\n\t\t\t\t\tif (isArray) {\r\n\t\t\t\t\t\t// views and data are arrays\r\n\t\t\t\t\t\tcurrent = viewsCount;\r\n\t\t\t\t\t\twhile (current--) {\r\n\t\t\t\t\t\t\tremoveView(current);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tself.views = [];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// views and data are objects\r\n\t\t\t\t\t\tfor (view in views) {\r\n\t\t\t\t\t\t\t// Remove by key\r\n\t\t\t\t\t\t\tremoveView(view);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tself.views = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (itemsCount === undefined) {\r\n\t\t\t\t\t\tif (isArray) {\r\n\t\t\t\t\t\t\t// The parentView is data array view.\r\n\t\t\t\t\t\t\t// Set itemsCount to 1, to remove this item\r\n\t\t\t\t\t\t\titemsCount = 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// Remove child view with key 'index'\r\n\t\t\t\t\t\t\tremoveView(index);\r\n\t\t\t\t\t\t\tdelete views[index];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (isArray && itemsCount\r\n\t\t\t\t\t\t&& viewsCount - itemsCount === self.data.length) { // If views not already synced to array (e.g. triggered by array.length propertyChange - jsviews/issues/301)\r\n\t\t\t\t\t\tcurrent = index + itemsCount;\r\n\t\t\t\t\t\t// Remove indexed items (parentView is data array view);\r\n\t\t\t\t\t\twhile (current-- > index) {\r\n\t\t\t\t\t\t\tremoveView(current);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tviews.splice(index, itemsCount);\r\n\t\t\t\t\t\tif (viewsCount = views.length) {\r\n\t\t\t\t\t\t\t// Fixup index on following view items...\r\n\t\t\t\t\t\t\twhile (index < viewsCount) {\r\n\t\t\t\t\t\t\t\t$observable(views[index]).setProperty(\"index\", index++);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn this;\r\n\t\t\t},\r\n\r\n\t\t\trefresh: function(context) {\r\n\t\t\t\tvar self = this,\r\n\t\t\t\t\tparent = self.parent;\r\n\r\n\t\t\t\tif (parent) {\r\n\t\t\t\t\trenderAndLink(self, self.index, self.tmpl, parent.views, self.data, context, true);\r\n\t\t\t\t\tsetArrayChangeLink(self);\r\n\t\t\t\t}\r\n\t\t\t\treturn self;\r\n\t\t\t},\r\n\r\n\t\t\tlink: viewLink\r\n\t\t}\r\n\t);\r\n\r\n\t//========================\r\n\t// JsViews-specific converters\r\n\t//========================\r\n\r\n\t$converters.merge = function(val) {\r\n\t\t// Special converter used in data-linking to space-separated lists, such as className:\r\n\t\t// Currently only supports toggle semantics - and has no effect if toggle string is not specified\r\n\t\t// data-link=\"class{merge:boolExpr toggle=className}\"\r\n\t\tvar regularExpression,\r\n\t\t\tcurrentValue = this.linkCtx._val || \"\",\r\n\t\t\ttoggle = this.tagCtx.props.toggle;\r\n\r\n\t\tif (toggle) {\r\n\t\t\t// We are toggling the class specified by the toggle property,\r\n\t\t\t// and the boolean val binding is driving the insert/remove toggle\r\n\r\n\t\t\tregularExpression = toggle.replace(/[\\\\^$.|?*+()[{]/g, \"\\\\$&\");\r\n\t\t\t// Escape any regular expression special characters (metacharacters) within the toggle string\r\n\t\t\tregularExpression = \"(\\\\s(?=\" + regularExpression + \"$)|(\\\\s)|^)(\" + regularExpression + \"(\\\\s|$))\";\r\n\t\t\t// Example: /(\\s(?=myclass$)|(\\s)|^)?(myclass(\\s|$))/ - so matches (\" myclass\" or \" \" or ^ ) followed by (\"myclass \" or \"myclass$\") where ^/$ are beginning/end of string\r\n\t\t\tcurrentValue = currentValue.replace(new RegExp(regularExpression), \"$2\");\r\n\t\t\tval = currentValue + (val ? (currentValue && \" \") + toggle : \"\");\r\n\t\t}\r\n\t\treturn val;\r\n\t};\r\n\r\n\t//========================\r\n\t// JsViews-specific tags\r\n\t//========================\r\n\r\n\t$tags(\"on\", {\r\n\t\tattr: NONE,\r\n\t\tinit: function(tagCtx) {\r\n\t\t\tvar tag = this,\r\n\t\t\t\tprops = tagCtx.props,\r\n\t\t\t\tcontent = tagCtx.content,\r\n\t\t\t\telemType = props.elem;\r\n\r\n\t\t\tif (tag._.inline) {\r\n\t\t\t\ttag.attr = HTML;\r\n\t\t\t\telemType = (elemType || \"span\") + \">\";\r\n\t\t\t\ttag.template = \"<\" + elemType + (props.label || content.markup || tagCtx.params.args[0]) + \"</\" + elemType;\r\n\t\t\t}\r\n\t\t},\r\n\t\trender: function() {\r\n\t\t\tvar tagCtx = this.tagCtx;\r\n\t\t\treturn tagCtx.render(tagCtx.view, true); // no arg, so renders against parentView.data\r\n\t\t},\r\n\t\tonAfterLink: function(tagCtx, linkCtx) {\r\n\t\t\tvar handler, params,\r\n\t\t\t\ttag = this,\r\n\t\t\t\ti = 0,\r\n\t\t\t\targs = tagCtx.args, // [events,] [selector,] handler\r\n\t\t\t\tl = args.length,\r\n\t\t\t\tprops = tagCtx.props,\r\n\t\t\t\tdata = props.data,\r\n\t\t\t\tview = tagCtx.view,\r\n\t\t\t\tcontextOb = props.context; // Context ('this' pointer) for attached handler\r\n\r\n\t\t\ttag.activeElem = tag.activeElem || $(tag._.inline ? (tag._elCnt && error('Use data-link=\"{on...}\"'), tag.nodes()[0]) : linkCtx.elem);\r\n\r\n\t\t\twhile (i<l && !(params = $isFunction(handler = args[i++]))) {} // Handler is first arg of type function\r\n\r\n\t\t\tif (params) { // There is a handler\r\n\t\t\t\tparams = args.slice(i); // Subsequent args are params\r\n\t\t\t\targs = args.slice(0, i - 1); // Preceding args (if any) are events and selector\r\n\r\n\t\t\t\tif (!contextOb) {\r\n\t\t\t\t\t// Get the path for the preceding object (context object) of handler (which is the last arg), compile function\r\n\t\t\t\t\t// to return that context object, and run compiled function against data\r\n\t\t\t\t\tcontextOb = /^(.*)[\\.^][\\w$]+$/.exec(tagCtx.params.args.slice(-params.length - 1)[0]);\r\n\t\t\t\t\tcontextOb = contextOb && $sub.tmplFn(\"{:\" + contextOb[1] + \"}\", view.tmpl, true)(linkCtx.data, view);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (tag._evs) {\r\n\t\t\t\t\ttag.onDispose();\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttag.activeElem.on(\r\n\t\t\t\t\ttag._evs = args[0] || \"click\", // events defaults to \"click\"\r\n\t\t\t\t\ttag._sel = args[1],\r\n\t\t\t\t\tdata == undefined ? null : data,\r\n\t\t\t\t\ttag._hlr = function(ev) {\r\n\t\t\t\t\t\treturn handler.apply(contextOb || linkCtx.data, [].concat(\r\n\t\t\t\t\t\t\tparams, // e.g. par1, par2\r\n\t\t\t\t\t\t\tev,\r\n\t\t\t\t\t\t\t{change: ev.type, view: view, linkCtx: linkCtx},\r\n\t\t\t\t\t\t\tparams.slice.call(arguments, 1) // If triggering event (e.g. jsv-domchange) has additional arguments after ev, pass them too\r\n\t\t\t\t\t\t));\r\n\t\t\t\t\t\t// for {on 'click' handler par1 par2} use handler(par1, par2, ev, domchangeEventArgs)\r\n\t\t\t\t\t\t// for {on 'jsv-domchange' handler par1 par2} use hanlder(par1, par2, ev, domchangeEventArgs, tagCtx, linkCtx, observableEventArgs)\r\n\t\t\t\t\t}\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t},\r\n\t\tonUpdate: function() {\r\n\t\t\treturn false;\r\n\t\t},\r\n\t\tonDispose: function() {\r\n\t\t\tthis.activeElem.off(this._evs, this._sel, this._hlr);\r\n\t\t},\r\n\t\tflow: true\r\n\t});\r\n\r\n\t$extend($tags[\"for\"], {\r\n\t\t//onUpdate: function(ev, eventArgs, tagCtxs) {\r\n\t\t\t//Consider adding filtering for perf optimization. However the below prevents update on some scenarios which _should_ update - namely when there is another array on which for also depends.\r\n\t\t\t//var i, l, tci, prevArg;\r\n\t\t\t//for (tci = 0; (prevArg = this.tagCtxs[tci]) && prevArg.args.length; tci++) {\r\n\t\t\t//\tif (prevArg.args[0] !== tagCtxs[tci].args[0]) {\r\n\t\t\t//\t\treturn true;\r\n\t\t\t//\t}\r\n\t\t\t//}\r\n\t\t\t//return false;\r\n\t\t//},\r\n\t\tonArrayChange: function(ev, eventArgs, tagCtx, linkCtx) {\r\n\t\t\tvar arrayView,\r\n\t\t\t\ttarget = ev.target,\r\n\t\t\t\ttargetLength = target.length,\r\n\t\t\t\ttag = this,\r\n\t\t\t\tchange = eventArgs.change;\r\n\t\t\tif (tag._.noVws // Child views not supported because target is not html - e.g. data-link=\"title{for ...}\"\r\n\t\t\t\t|| tag.tagCtxs[1] && ( // There is an {{else}}\r\n\t\t\t\t\tchange === \"insert\" && targetLength === eventArgs.items.length // inserting, and new length is same as inserted length, so going from 0 to n\r\n\t\t\t\t\t|| change === \"remove\" && !targetLength // removing , and new length 0, so going from n to 0\r\n\t\t\t\t\t|| change === \"refresh\" && !eventArgs.oldItems.length !== !targetLength // refreshing, and length is going from 0 to n or from n to 0\r\n\t\t\t\t)) {\r\n\t\t\t\ttag.refresh();\r\n\t\t\t} else {\r\n\t\t\t\tfor (arrayView in tag._.arrVws) {\r\n\t\t\t\t\tarrayView = tag._.arrVws[arrayView];\r\n\t\t\t\t\tif (arrayView.data === target) {\r\n\t\t\t\t\t\tarrayView._.onArrayChange.apply(arrayView, arguments);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttag.domChange(tagCtx, linkCtx, eventArgs);\r\n\t\t\tev.done = true;\r\n\t\t},\r\n\t\tonAfterLink: function(tagCtx, linkCtx) {\r\n\t\t\tvar i, arrHandler, arrBinding, data,\r\n\t\t\t\ttag = this,\r\n\t\t\t\tarrayBindings = tag._ars || {},\r\n\t\t\t\ttagCtxs = tag.tagCtxs,\r\n\t\t\t\tl = tagCtxs.length,\r\n\t\t\t\tselected = tag.selected || 0;\r\n\r\n\t\t\tfor (i = 0; i <= selected; i++) {\r\n\t\t\t\ttagCtx = tagCtxs[i];        // loop through tagCtxs up to selected\r\n\t\t\t\tdata = tagCtx.map\r\n\t\t\t\t\t? tagCtx.map.tgt        // 'data' is mapped data\r\n\t\t\t\t\t: tagCtx.args.length\r\n\t\t\t\t\t\t? tagCtx.args[0]    // or args[0]\r\n\t\t\t\t\t\t: tagCtx.view.data; // or defaults to current data.\r\n\r\n\t\t\t\tif ((arrBinding = arrayBindings[i]) && data !== arrBinding[0]) { // Is there previous array data on this tagCtx, different from new data\r\n\t\t\t\t\t$observe(arrBinding[0], arrBinding[1], true); //unobserve previous array\r\n\t\t\t\t\tdelete arrayBindings[i];\r\n\t\t\t\t}\r\n\t\t\t\tif (!arrayBindings[i] && $.isArray(data)) {\r\n\t\t\t\t\t$observe(data, arrHandler = function(ev, eventArgs) {\r\n\t\t\t\t\t\tvar tagCt = tagCtx;\r\n\t\t\t\t\t\ttag.onArrayChange(ev, eventArgs, tagCt, linkCtx);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tarrayBindings[i] = [data, arrHandler]; // Store array data and arrayChangeHandler on tag._ars[i]\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tfor (i = selected + 1; i < l; i++) { // If there were previous bindings on later tagCtxs, remove them\r\n\t\t\t\tif (arrBinding = arrayBindings[i]) {\r\n\t\t\t\t\t$observe(arrBinding[0], arrBinding[1], true); //unobserve previous binding\r\n\t\t\t\t\tdelete arrayBindings[i];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttag._ars = arrayBindings;\r\n\t\t},\r\n\t\tonDispose: function() {\r\n\t\t\tvar l, tag = this;\r\n\t\t\tfor (l in tag._ars) {\r\n\t\t\t\t$observe(tag._ars[l][0], tag._ars[l][1], true); //unobserve\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\t$extend($tags[\"for\"], linkMethods);\r\n\t$extend($tags[\"if\"], linkMethods);\r\n\t$extend($tags.include, linkMethods);\r\n\r\n\t$extend($tags[\"if\"], {\r\n\t\tonUpdate: function(ev, eventArgs, tagCtxs) {\r\n\t\t\tvar tci, prevArg, different;\r\n\t\t\tfor (tci = 0; (prevArg = this.tagCtxs[tci]) && prevArg.args.length; tci++) {\r\n\t\t\t\tprevArg = prevArg.args[0];\r\n\t\t\t\tdifferent = !prevArg !== !tagCtxs[tci].args[0];\r\n\t\t\t\tif ((!this.convert && !!prevArg) || different) {\r\n\t\t\t\t\treturn different;\r\n\t\t\t\t\t// If there is no converter, and newArg and prevArg are both truthy, return false to cancel update. (Even if values on later elses are different, we still don't want to update, since rendered output would be unchanged)\r\n\t\t\t\t\t// If newArg and prevArg are different, return true, to update\r\n\t\t\t\t\t// If newArg and prevArg are both falsey, move to the next {{else ...}}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// Boolean value of all args are unchanged (falsey), so return false to cancel update\r\n\t\t\treturn false;\r\n\t\t},\r\n\t\tonAfterLink: function(tagCtx, linkCtx, eventArgs) {\r\n\t\t\tif (eventArgs) {\r\n\t\t\t\tthis.domChange(tagCtx, linkCtx, eventArgs);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tfunction observeProps(map, ev, eventArgs) {\r\n\t\tif (eventArgs.change === \"set\") {\r\n\t\t\tvar target = map.tgt,\r\n\t\t\t\tl = target.length;\r\n\t\t\twhile (l--) {\r\n\t\t\t\tif (target[l].key === eventArgs.path) {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (l === -1) {\r\n\t\t\t\tif (eventArgs.path && !eventArgs.remove) {\r\n\t\t\t\t\t$observable(target).insert({ key: eventArgs.path, prop: eventArgs.value });\r\n\t\t\t\t}\r\n\t\t\t} else if (eventArgs.remove) {\r\n\t\t\t\t$observable(target).remove(l);\r\n\t\t\t} else {\r\n\t\t\t\t$observable(target[l]).setProperty(\"prop\", eventArgs.value);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction observeMappedProps(map, ev, eventArgs) {\r\n\t\tvar item,\r\n\t\t\tsource = map.src,\r\n\t\t\tchange = eventArgs.change;\r\n\r\n\t\tif (change === \"set\") {\r\n\t\t\tif (eventArgs.path === \"prop\") {\r\n\t\t\t\t$observable(source).setProperty(ev.target.key, eventArgs.value);\r\n\t\t\t} else { // path === \"key\"\r\n\t\t\t\t$observable(source).setProperty(eventArgs.oldValue, null);\r\n\t\t\t\tdelete source[eventArgs.oldValue];\r\n\t\t\t\t$observable(source).setProperty(eventArgs.value, ev.target.prop);\r\n\t\t\t}\r\n\t\t} else if (change === \"remove\") {\r\n\t\t\titem = eventArgs.items[0];\r\n\t\t\t$observable(source).removeProperty(item.key);\r\n\t\t\tdelete source[item.key];\r\n\t\t} else if (change === \"insert\") {\r\n\t\t\titem = eventArgs.items[0];\r\n\t\t\tif (item.key) {\r\n\t\t\t\t$observable(source).setProperty(item.key, item.prop);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction shallowArrayFilter(allPath /*, object, parentObs*/) { // Filter used by {{props}} for the mappedProps target array\r\n\t\treturn allPath.indexOf(\".\") < 0;\r\n\t}\r\n\r\n\t$tags(\"props\", {\r\n\t\tbaseTag: \"for\",\r\n\t\tdataMap: $views.map({\r\n\t\t\tgetTgt: $tags.props.dataMap.getTgt,\r\n\t\t\tobsSrc: observeProps,\r\n\t\t\tobsTgt: observeMappedProps,\r\n\t\t\ttgtFlt: shallowArrayFilter\r\n\t\t}),\r\n\t\tflow: true\r\n\t});\r\n\r\n\t//========================\r\n\t// Extend jQuery namespace\r\n\t//========================\r\n\r\n\t$extend($, {\r\n\r\n\t\t//=======================\r\n\t\t// jQuery $.view() plugin\r\n\t\t//=======================\r\n\r\n\t\tview: $views.view = $view = function(node, inner, type) {\r\n\t\t\t// $.view() returns top view\r\n\t\t\t// $.view(node) returns view that contains node\r\n\t\t\t// $.view(selector) returns view that contains first selected element\r\n\t\t\t// $.view(nodeOrSelector, type) returns nearest containing view of given type\r\n\t\t\t// $.view(nodeOrSelector, \"root\") returns root containing view (child of top view)\r\n\t\t\t// $.view(nodeOrSelector, true, type) returns nearest inner (contained) view of given type\r\n\r\n\t\t\tfunction getInnerView(nd, isVl) {\r\n\t\t\t\tif (nd) {\r\n\t\t\t\t\tvwInfos = viewInfos(nd, isVl, rOpenViewMarkers);\r\n\t\t\t\t\tfor (j = 0, k = vwInfos.length; j < k; j++) {\r\n\t\t\t\t\t\tif ((view = viewStore[vwInfos[j].id]) && (view = view && type ? view.get(true, type) : view)) {\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (inner !== !!inner) {\r\n\t\t\t\t// inner not boolean, so this is view(nodeOrSelector, type)\r\n\t\t\t\ttype = inner;\r\n\t\t\t\tinner = undefined;\r\n\t\t\t}\r\n\t\t\tvar view, vwInfos, i, j, k, l, elems,\r\n\t\t\t\tlevel = 0,\r\n\t\t\t\tbody = document.body;\r\n\r\n\t\t\tif (node && node !== body && topView._.useKey > 1) {\r\n\t\t\t\t// Perf optimization for common cases\r\n\r\n\t\t\t\tnode = \"\" + node === node\r\n\t\t\t\t\t? $(node)[0]\r\n\t\t\t\t\t: node.jquery\r\n\t\t\t\t\t\t? node[0]\r\n\t\t\t\t\t\t: node;\r\n\r\n\t\t\t\tif (node) {\r\n\t\t\t\t\tif (inner) {\r\n\t\t\t\t\t\tgetInnerView(node._df, true);\r\n\t\t\t\t\t\tif (!view) {\r\n\t\t\t\t\t\t\t// Treat supplied node as a container element and return the first view encountered.\r\n\t\t\t\t\t\t\telems = qsa ? node.querySelectorAll(bindElsSel) : $(bindElsSel, node).get();\r\n\t\t\t\t\t\t\tl = elems.length;\r\n\t\t\t\t\t\t\tfor (i = 0; !view && i < l; i++) {\r\n\t\t\t\t\t\t\t\tgetInnerView(elems[i]);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t}\r\n\t\t\t\t\twhile (node) {\r\n\t\t\t\t\t\t// Move back through siblings and up through parents to find preceding node which is a _prv (prevNode)\r\n\t\t\t\t\t\t// script marker node for a non-element-content view, or a _prv (first node) for an elCnt view\r\n\t\t\t\t\t\tif (vwInfos = viewInfos(node, undefined, rViewMarkers)) {\r\n\t\t\t\t\t\t\tl = vwInfos.length;\r\n\t\t\t\t\t\t\twhile (l--) {\r\n\t\t\t\t\t\t\t\tview = vwInfos[l];\r\n\t\t\t\t\t\t\t\tif (view.open) {\r\n\t\t\t\t\t\t\t\t\tif (level < 1) {\r\n\t\t\t\t\t\t\t\t\t\tview = viewStore[view.id];\r\n\t\t\t\t\t\t\t\t\t\treturn view && type ? view.get(type) : view || topView;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tlevel--;\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t// level starts at zero. If we hit a view.close, then we move level to 1, and we don't return a view until\r\n\t\t\t\t\t\t\t\t\t// we are back at level zero (or a parent view with level < 0)\r\n\t\t\t\t\t\t\t\t\tlevel++;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnode = node.previousSibling || node.parentNode;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn topView;\r\n\t\t},\r\n\r\n\t\tlink: $views.link = $link,\r\n\t\tunlink: $views.unlink = $unlink,\r\n\r\n\t\t//=====================\r\n\t\t// override $.cleanData\r\n\t\t//=====================\r\n\t\tcleanData: function(elems) {\r\n\t\t\tif (elems.length && isCleanCall) {\r\n\t\t\t\t// Remove JsViews bindings. Also, remove from the DOM any corresponding script marker nodes\r\n\t\t\t\tclean(elems);\r\n\t\t\t}\r\n\t\t\toldCleanData.apply($, arguments);\r\n\t\t}\r\n\t});\r\n\r\n\t$views.utility = {\r\n\t\tvalidate: function(html) {\r\n\t\t\ttry {\r\n\t\t\t\ttopView.link(undefined, document.createElement(\"div\"), undefined, undefined, html, undefined, undefined, 1);\r\n\t\t\t}\r\n\t\t\tcatch (e) {\r\n\t\t\t\treturn e.message;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\t//===============================\r\n\t// Extend jQuery instance plugins\r\n\t//===============================\r\n\r\n\t$extend($.fn, {\r\n\t\tlink: function(expr, from, context, noIteration, parentView, prevNode, nextNode) {\r\n\t\t\treturn $link(expr, this, from, context, noIteration, parentView, prevNode, nextNode);\r\n\t\t},\r\n\t\tunlink: function(expr) {\r\n\t\t\treturn $unlink(expr, this);\r\n\t\t},\r\n\t\tview: function(inner, type) {\r\n\t\t\treturn $view(this[0], inner, type);\r\n\t\t}\r\n\t});\r\n\r\n\t//==============================================================================\r\n\t// Override jQuery methods that call our overridden cleanData, for disposal etc.\r\n\t//==============================================================================\r\n\r\n\t$.each([HTML, \"replaceWith\", \"empty\", \"remove\"], function(i, name) {\r\n\t\tvar oldFn = $.fn[name];\r\n\t\t$.fn[name] = function() {\r\n\t\t\tvar result;\r\n\t\t\tisCleanCall = 1; // Make sure cleanData does disposal only when coming from these calls.\r\n\t\t\ttry {\r\n\t\t\t\tresult = oldFn.apply(this, arguments);\r\n\t\t\t}\r\n\t\t\tfinally {\r\n\t\t\t\tisCleanCall = 0;\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t};\r\n\t});\r\n\r\n\t//===============\r\n\t// Extend topView\r\n\t//===============\r\n\r\n\t$extend(topView = $sub.topView, {tmpl: {links: {}}});\r\n\r\n\tviewStore = { 0: topView }; // Top-level view\r\n\r\n\t//=========================\r\n\t// Extend $.views.settings\r\n\t//=========================\r\n\r\n\t$viewsSettings({\r\n\t\twrapMap: wrapMap = {\r\n\t\t\toption: [1, \"<select multiple='multiple'>\", \"</select>\"],\r\n\t\t\tlegend: [1, \"<fieldset>\", \"</fieldset>\"],\r\n\t\t\tarea: [1, \"<map>\", \"</map>\"],\r\n\t\t\tparam: [1, \"<object>\", \"</object>\"],\r\n\t\t\tthead: [1, \"<table>\", \"</table>\"],\r\n\t\t\ttr: [2, \"<table><tbody>\", \"</tbody></table>\"],\r\n\t\t\ttd: [3, \"<table><tbody><tr>\", \"</tr></tbody></table>\"],\r\n\t\t\tcol: [2, \"<table><tbody></tbody><colgroup>\", \"</colgroup></table>\"],\r\n\t\t\tsvg_ns: [1, \"<svg>\", \"</svg>\"],\r\n\r\n\t\t\t// IE6-8 can't serialize link, script, style, or any html5 (NoScope) tags,\r\n\t\t\t// unless wrapped in a div with non-breaking characters in front of it.\r\n\t\t\tdiv: jQuery.support.htmlSerialize ? [0, \"\", \"\"] : [1, \"X<div>\", \"</div>\"]\r\n\t\t},\r\n\t\tlinkAttr: $viewsLinkAttr = \"data-link\",\r\n\t\tmerge: {\r\n\t\t\tinput: {\r\n\t\t\t\tfrom: inputAttrib, to: \"value\"\r\n\t\t\t},\r\n\t\t\ttextarea: valueBinding,\r\n\t\t\tselect: valueBinding,\r\n\t\t\toptgroup: {\r\n\t\t\t\tto: \"label\"\r\n\t\t\t}\r\n\t\t},\r\n\t\tjsrDbgMode: $viewsSettings.debugMode, // debugMode for JsRender\r\n\t\tdebugMode: function(debugMode) { // debugMode for JsViews\r\n\t\t\t$viewsSettings.jsrDbgMode(debugMode);\r\n\t\t\tif ($viewsSettings._dbgMode) {\r\n\t\t\t\tglobal._jsv = { // In debug mode create global _jsv, for accessing views, etc\r\n\t\t\t\t\tviews: viewStore,\r\n\t\t\t\t\tbindings: bindingStore\r\n\t\t\t\t};\r\n\t\t\t} else {\r\n\t\t\t\tglobal._jsv = undefined;\r\n\t\t\t}\r\n\t\t},\r\n\t\tjsv: function() {\r\n\t\t\t$viewsSettings.debugMode($viewsSettings._dbgMode);\r\n\t\t\t$viewsLinkAttr = $viewsSettings.linkAttr;\r\n\t\t\terror = $views._err;\r\n\t\t\tlinkViewsSel = bindElsSel + \",[\" + $viewsLinkAttr + \"]\";\r\n\t\t\tnoDomLevel0 = $viewsSettings.noDomLevel0;\r\n\t\t\twrapMap.optgroup = wrapMap.option;\r\n\t\t\twrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;\r\n\t\t\twrapMap.th = wrapMap.td;\r\n\t\t}\r\n\t});\r\n\r\n\treturn $;\r\n}));\r\n"],"sourceRoot":"/source/"}